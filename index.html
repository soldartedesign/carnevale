<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèóÔ∏è Sistema de Gesti√≥n Ferreter√≠a Carnevale</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    
    <style>
        /* ===== ESTILOS ORIGINALES MEJORADOS ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            min-height: 90vh;
            display: none;
        }

        /* Header - Redise√±ado */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            color: white;
            padding: 15px 30px;
            position: relative;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .sucursal-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 25px;
            min-width: 200px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .sucursal-info {
            flex: 1;
        }

        .sucursal-label {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 2px;
            display: block;
        }

        #sucursalNombre {
            font-weight: 600;
            font-size: 14px;
            color: white;
        }

        .btn-sucursal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-sucursal:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .header-title {
            flex: 2;
            text-align: center;
        }

        .header-title h1 {
            font-size: 24px;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header-subtitle {
            font-size: 12px;
            opacity: 0.85;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            flex-wrap: wrap;
        }

        .credit {
            color: #3498db;
            font-weight: 500;
        }

        .separator {
            opacity: 0.5;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
            min-width: 200px;
            justify-content: flex-end;
        }

        .user-label {
            font-size: 11px;
            opacity: 0.7;
        }

        #userEmail {
            font-size: 13px;
            font-weight: 500;
        }

        .btn-logout {
            background: rgba(231, 76, 60, 0.3);
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-logout:hover {
            background: rgba(231, 76, 60, 0.5);
        }

        .nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            padding: 0;
            overflow-x: auto;
        }

        .nav-button {
            flex-shrink: 0;
            padding: 18px 20px;
            background: none;
            border: none;
            border-right: 1px solid #e9ecef;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            white-space: nowrap;
        }

        .nav-button:last-child {
            border-right: none;
        }

        .nav-button:hover {
            background: #e9ecef;
            color: #2c3e50;
        }

        .nav-button.active {
            background: #3498db;
            color: white;
            box-shadow: inset 0 -3px 0 #2980b9;
        }

        .nav-button.logout {
            margin-left: auto;
            background: #e74c3c;
            color: white;
        }

        .nav-button.logout:hover {
            background: #c0392b;
        }

        .section {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 5px solid #3498db;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .card h3 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card .number {
            font-size: 42px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .card .subtext {
            font-size: 13px;
            color: #95a5a6;
        }

        .card.urgente { border-left-color: #e74c3c; }
        .card.recibido { border-left-color: #2ecc71; }
        .card.en-camino { border-left-color: #f39c12; }

        .alertas-container {
            background: #fff8e1;
            border: 1px solid #ffecb3;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }

        .alerta-item {
            padding: 12px 15px;
            margin: 8px 0;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #f39c12;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alerta-item.urgente {
            border-left-color: #e74c3c;
            background: #ffeaea;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            margin-top: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            background: #f8f9fa;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .form-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 12px;
            padding-right: 40px;
            cursor: pointer;
        }

        select.form-control:disabled {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        .btn-nuevo-proveedor {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background: #e3f2fd;
            border: 2px dashed #3498db;
            border-radius: 8px;
            color: #3498db;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-nuevo-proveedor:hover {
            background: #3498db;
            color: white;
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: none;
        }

        .autocomplete-list.active {
            display: block;
        }

        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: #f8f9fa;
        }

        .autocomplete-item strong {
            display: block;
            margin-bottom: 3px;
        }

        .autocomplete-item small {
            color: #666;
            font-size: 12px;
        }

        .nuevo-producto-fields {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            border-left: 4px solid #3498db;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nuevo-producto-header {
            color: #3498db;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }

        .faltantes-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .faltantes-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 500;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border-right: 1px solid #e9ecef;
        }

        .faltantes-tab:last-child {
            border-right: none;
        }

        .faltantes-tab:hover {
            background: #e9ecef;
        }

        .faltantes-tab.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .badge-pendiente {
            background: #ffeaa7;
            color: #856404;
        }

        .badge-pedido {
            background: #a3e4d7;
            color: #0e6251;
        }

        .badge-cerrado {
            background: #abebc6;
            color: #145a32;
        }

        .badge-urgente {
            background: #fadbd8;
            color: #78281f;
        }

        .badge-en-camino {
            background: #a3e4d7;
            color: #0e6251;
        }

        .badge-recibido {
            background: #abebc6;
            color: #145a32;
        }

        .badge-cancelado {
            background: #e2e3e5;
            color: #383d41;
        }

        .badge-quedan-pocos {
            background: #fff3cd;
            color: #856404;
        }

        .badge-sin-stock {
            background: #f8d7da;
            color: #721c24;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
            max-width: 400px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            background: #2ecc71;
            border-left: 5px solid #27ae60;
        }

        .notification.error {
            background: #e74c3c;
            border-left: 5px solid #c0392b;
        }

        .notification.warning {
            background: #f39c12;
            border-left: 5px solid #d68910;
        }

        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }

        .login-container h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .login-form input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 15px;
            transition: border 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #3498db;
        }

        .login-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
        }

        .login-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 500;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-container {
            background: white;
            border-radius: 15px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-proveedor {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-small {
            max-width: 500px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header-top {
                flex-direction: column;
                gap: 10px;
            }

            .sucursal-selector,
            .user-info {
                width: 100%;
                justify-content: center;
            }

            .header-title h1 {
                font-size: 20px;
            }

            .header-subtitle {
                font-size: 11px;
            }

            .nav {
                flex-direction: column;
            }

            .nav-button {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
                justify-content: flex-start;
            }

            .section {
                padding: 20px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            th, td {
                padding: 12px 8px;
                font-size: 14px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            table {
                min-width: 600px;
            }

            .faltantes-tabs {
                flex-direction: column;
            }

            .faltantes-tab {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }

            .login-container {
                padding: 30px 20px;
            }

            .modal-container {
                max-height: 95vh;
            }

            .modal-body {
                padding: 20px;
            }
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mb-3 {
            margin-bottom: 1rem;
        }

        .mt-3 {
            margin-top: 1rem;
        }

        .flex {
            display: flex;
        }

        .justify-between {
            justify-content: space-between;
        }

        .items-center {
            align-items: center;
        }

        .w-100 {
            width: 100%;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .sucursal-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .sucursal-badge.activa {
            background: #d4edda;
            color: #155724;
        }
        
        .sucursal-badge.otra {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .producto-checkbox {
            transform: scale(1.3);
            margin: 0;
            cursor: pointer;
        }
        
        .producto-checkbox:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-group-sm {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn-group-sm .btn {
            padding: 6px 12px;
            font-size: 12px;
        }

        .contador-faltantes {
            background: #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
        }

        .contador-numero {
            font-size: 32px;
            font-weight: bold;
            color: #e74c3c;
            margin: 10px 0;
        }

        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            margin-bottom: 15px;
        }

        .stats-card h4 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 14px;
            text-transform: uppercase;
        }

        .stats-number {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
        }

        .producto-critico {
            border-left: 4px solid #e74c3c !important;
            background: #ffeaea;
        }

        .producto-alto {
            border-left: 4px solid #f39c12 !important;
            background: #fff3cd;
        }

        .producto-medio {
            border-left: 4px solid #3498db !important;
            background: #e3f2fd;
        }

        .badge-prioridad {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .badge-alta {
            background: #e74c3c;
            color: white;
        }

        .badge-media {
            background: #f39c12;
            color: white;
        }

        .badge-baja {
            background: #2ecc71;
            color: white;
        }

        .ai-sugerencia {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .ai-resaltado {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(33, 150, 243, 0); }
            100% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0); }
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .btn-pagination {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-pagination:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 14px;
            color: #495057;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <h1>üèóÔ∏è Ferreter√≠a Carnevale</h1>
            
            <div class="login-tabs">
                <button class="login-tab active" onclick="showLoginTab('login')">Iniciar Sesi√≥n</button>
                <button class="login-tab" onclick="showLoginTab('register')">Registrarse</button>
            </div>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="loginEmail">Correo electr√≥nico</label>
                    <input type="email" id="loginEmail" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Contrase√±a</label>
                    <input type="password" id="loginPassword" class="form-control" required>
                </div>
                
                <button type="submit" class="btn btn-primary w-100">
                    Iniciar Sesi√≥n
                </button>
            </form>
            
            <form id="registerForm" class="login-form hidden">
                <div class="form-group">
                    <label for="registerName">Nombre completo</label>
                    <input type="text" id="registerName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="registerEmail">Correo electr√≥nico</label>
                    <input type="email" id="registerEmail" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="registerPassword">Contrase√±a</label>
                    <input type="password" id="registerPassword" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="registerConfirmPassword">Confirmar contrase√±a</label>
                    <input type="password" id="registerConfirmPassword" class="form-control" required>
                </div>
                
                <button type="submit" class="btn btn-success w-100">
                    Crear Cuenta
                </button>
            </form>
            
            <div class="text-center mt-3">
                <small class="text-muted">
                    Sistema de gesti√≥n para ferreter√≠as
                </small>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingMessage" style="margin-top: 20px; color: #3498db; font-weight: bold;"></div>
    </div>

    <!-- Modal de Revisi√≥n de Pedidos -->
    <div class="modal-overlay" id="modalRevision">
        <div class="modal-container">
            <div class="modal-header">
                <h3>üìã Revisi√≥n de Pedido</h3>
                <button class="modal-close" onclick="cerrarModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="modalContent">
                </div>
                <div class="modal-actions" id="modalRevisionActions">
                    <button class="btn" onclick="cerrarModal()">Cancelar</button>
                    <button class="btn btn-success" id="btnConfirmarPedido" onclick="confirmarPedido()">‚úÖ Confirmar y Generar Pedido</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Recepci√≥n de Pedido -->
    <div class="modal-overlay" id="modalRecepcion">
        <div class="modal-container">
            <div class="modal-header">
                <h3>üì¶ Recepci√≥n de Pedido</h3>
                <button class="modal-close" onclick="cerrarModalRecepcion()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="modalRecepcionContent">
                </div>
                <div class="modal-actions">
                    <button class="btn" onclick="cerrarModalRecepcion()">Cancelar</button>
                    <button class="btn btn-success" id="btnConfirmarRecepcion" onclick="confirmarRecepcionParcial()">‚úÖ Confirmar Recepci√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Nuevo Proveedor -->
    <div class="modal-overlay" id="modalNuevoProveedor">
        <div class="modal-container modal-small">
            <div class="modal-header">
                <h3>üë• Nuevo Proveedor</h3>
                <button class="modal-close" onclick="cerrarModalNuevoProveedor()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="formNuevoProveedor" onsubmit="guardarNuevoProveedor(event)">
                    <div class="form-group">
                        <label for="nuevoProveedorNombre">Nombre del Proveedor *</label>
                        <input type="text" id="nuevoProveedorNombre" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="nuevoProveedorMedio">Medio de Pedido *</label>
                        <select id="nuevoProveedorMedio" class="form-control" onchange="actualizarCampoContactoProveedor()">
                            <option value="WhatsApp">üì± WhatsApp</option>
                            <option value="Web">üåê Web</option>
                            <option value="Manual">üìû Manual</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label id="labelNuevoProveedorContacto" for="nuevoProveedorContacto">Contacto *</label>
                        <input type="text" id="nuevoProveedorContacto" class="form-control" 
                               placeholder="Depende del medio seleccionado..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="nuevoProveedorLinkWeb">Link Web (si aplica)</label>
                        <input type="url" id="nuevoProveedorLinkWeb" class="form-control" 
                               placeholder="https://ejemplo.com">
                    </div>
                    
                    <div class="button-group">
                        <button type="button" class="btn" onclick="cerrarModalNuevoProveedor()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Proveedor</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Editar Proveedor -->
    <div class="modal-overlay" id="modalEditarProveedor">
        <div class="modal-container modal-small">
            <div class="modal-header">
                <h3>‚úèÔ∏è Editar Proveedor</h3>
                <button class="modal-close" onclick="cerrarModalEditarProveedor()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="formEditarProveedor" onsubmit="actualizarProveedor(event)">
                    <input type="hidden" id="editarProveedorId">
                    
                    <div class="form-group">
                        <label for="editarProveedorNombre">Nombre del Proveedor *</label>
                        <input type="text" id="editarProveedorNombre" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editarProveedorMedio">Medio de Pedido *</label>
                        <select id="editarProveedorMedio" class="form-control" onchange="actualizarCampoContactoEditar()">
                            <option value="WhatsApp">üì± WhatsApp</option>
                            <option value="Web">üåê Web</option>
                            <option value="Manual">üìû Manual</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label id="labelEditarProveedorContacto" for="editarProveedorContacto">Contacto *</label>
                        <input type="text" id="editarProveedorContacto" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editarProveedorLinkWeb">Link Web (si aplica)</label>
                        <input type="url" id="editarProveedorLinkWeb" class="form-control">
                    </div>
                    
                    <div class="button-group">
                        <button type="button" class="btn" onclick="cerrarModalEditarProveedor()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Actualizar Proveedor</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Configuraci√≥n de Limpieza -->
    <div class="modal-overlay" id="modalConfigLimpieza">
        <div class="modal-container modal-small">
            <div class="modal-header">
                <h3>‚öôÔ∏è Configurar Limpieza de Pedidos</h3>
                <button class="modal-close" onclick="cerrarModalConfigLimpieza()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="formConfigLimpieza" onsubmit="guardarConfigLimpieza(event)">
                    <div class="form-group">
                        <label for="diasRetencion">
                            <strong>üìÖ D√≠as de retenci√≥n</strong>
                        </label>
                        <input type="number" id="diasRetencion" class="form-control" 
                               min="1" max="365" value="30" required>
                        <small class="text-muted">
                            Los pedidos recibidos hace m√°s d√≠as ser√°n eliminados autom√°ticamente
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="autoLimpieza">
                            <input type="checkbox" id="autoLimpieza" class="form-control" 
                                   style="width: auto; display: inline-block; margin-right: 10px;">
                            <strong>üîÑ Limpieza autom√°tica</strong>
                        </label>
                        <small class="text-muted">
                            Limpiar autom√°ticamente al abrir la secci√≥n de pedidos
                        </small>
                    </div>
                    
                    <div class="alertas-container mt-3">
                        <strong>üìä Estad√≠sticas actuales:</strong><br>
                        <div id="estadisticasLimpieza">
                            Cargando...
                        </div>
                    </div>
                    
                    <div class="button-group mt-3">
                        <button type="button" class="btn btn-warning" onclick="ejecutarLimpiezaManual()">
                            üßπ Ejecutar limpieza ahora
                        </button>
                        <button type="button" class="btn" onclick="cerrarModalConfigLimpieza()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            üíæ Guardar configuraci√≥n
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Aplicaci√≥n Principal -->
    <div class="app-container" id="appContainer">
        <div class="header">
            <div class="header-top">
                <div class="sucursal-selector">
                    <div class="sucursal-info">
                        <span class="sucursal-label">Sucursal Actual</span>
                        <div id="sucursalNombre" class="sucursal-name">Cargando...</div>
                    </div>
                    <button class="btn-sucursal" onclick="cambiarSucursal()" title="Cambiar sucursal">
                        üîÑ
                    </button>
                </div>

                <div class="header-title">
                    <h1>üèóÔ∏è Sistema de Gesti√≥n Ferreter√≠a Carnevale</h1>
                    <div class="header-subtitle">
                        <span class="credit">Creado por Sebastian Mascali</span>
                        <span class="separator">‚Ä¢</span>
                        <span>Gesti√≥n en tiempo real</span>
                        <span class="separator">‚Ä¢</span>
                        <span style="color:#4CAF50;">üìä An√°lisis Inteligente</span>
                    </div>
                </div>

                <div class="user-info">
                    <div class="user-details">
                        <span class="user-label">Usuario</span>
                        <div id="userEmail">cargando...</div>
                    </div>
                    <button class="btn-logout" onclick="logout()" title="Cerrar sesi√≥n">
                        Salir
                    </button>
                </div>
            </div>
        </div>

        <div class="nav">
            <button class="nav-button active" onclick="showSection('dashboard')">
                üìä Dashboard
            </button>
            <button class="nav-button" onclick="showSection('faltantes')">
                ‚ö†Ô∏è Faltantes
            </button>
            <button class="nav-button" onclick="showSection('pendientes')">
                üìã Pedidos Pendientes
            </button>
            <button class="nav-button" onclick="showSection('recepcion')">
                üì• Recepci√≥n
            </button>
            <button class="nav-button" onclick="showSection('historial')">
                üì¶ Historial
            </button>
            <button class="nav-button" onclick="showSection('catalogo')">
                üóÉÔ∏è Cat√°logo
            </button>
            <button class="nav-button" onclick="showSection('configuracion')">
                ‚öôÔ∏è Configuraci√≥n
            </button>
            <button class="nav-button logout" onclick="logout()">
                üëã Salir
            </button>
        </div>

        <div class="sections-container">
            <!-- DASHBOARD -->
            <section id="dashboard" class="section active">
                <div class="flex justify-between items-center mb-3">
                    <h2>üìä Dashboard en Tiempo Real</h2>
                    <button class="btn btn-primary" onclick="refreshDashboard()">
                        üîÑ Actualizar Todo
                    </button>
                </div>

                <div class="dashboard-grid">
                    <div class="card">
                        <h3>Faltantes Pendientes</h3>
                        <div class="number" id="metricFaltantesPendientes">0</div>
                        <div class="subtext">Requieren atenci√≥n</div>
                    </div>
                    
                    <div class="card en-camino">
                        <h3>Pedidos en Camino</h3>
                        <div class="number" id="metricPedidosCamino">0</div>
                        <div class="subtext">Por recibir</div>
                    </div>
                    
                    <div class="card recibido">
                        <h3>Pedidos Recibidos</h3>
                        <div class="number" id="metricPedidosRecibidos">0</div>
                        <div class="subtext">√öltimos 30 d√≠as</div>
                    </div>
                    
                    <div class="card urgente">
                        <h3>Faltantes Sin Stock</h3>
                        <div class="number" id="metricFaltantesSinStock">0</div>
                        <div class="subtext">Atenci√≥n inmediata</div>
                    </div>
                </div>

                <!-- PANEL DE AN√ÅLISIS DE INVENTARIO LOCAL MEJORADO -->
                <div class="form-container mt-3" id="panelAnalisisInventario">
                    <div class="flex justify-between items-center mb-3">
                        <h3>üìà An√°lisis Inteligente de Inventario</h3>
                        <button class="btn btn-primary" onclick="confirmarAnalisis()" id="btnAnalizarInventario">
                            üîÑ Analizar Ahora
                        </button>
                    </div>
                    
                    <!-- Resumen Ejecutivo -->
                    <div id="resumenAnalisis" class="alertas-container mb-3">
                        <div class="text-center">
                            <p>Haz clic en "Analizar Ahora" para revisar tu inventario</p>
                            <p><small>‚ö†Ô∏è El an√°lisis consume recursos de Firebase. √ösalo con moderaci√≥n.</small></p>
                        </div>
                    </div>
                    
                    <!-- Productos Cr√≠ticos -->
                    <div class="mb-3">
                        <h4>‚ö†Ô∏è Productos que Necesitan Atenci√≥n</h4>
                        <div id="listaProductosCriticos" class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>Motivo</th>
                                        <th>Acci√≥n Recomendada</th>
                                        <th>Prioridad</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaProductosCriticos">
                                    <tr><td colspan="4" class="text-center">Esperando an√°lisis...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Recomendaciones -->
                    <div class="mb-3">
                        <h4>üí° Recomendaciones Inteligentes</h4>
                        <div id="listaRecomendaciones" class="alertas-container">
                            <ul id="recomendacionesLista">
                                <li>El an√°lisis te dar√° recomendaciones espec√≠ficas para tu inventario</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Tendencias -->
                    <div class="mb-3">
                        <h4>üìä Tendencias Detectadas</h4>
                        <div id="listaTendencias" class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Categor√≠a</th>
                                        <th>Tendencia</th>
                                        <th>Observaci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaTendencias">
                                    <tr><td colspan="3" class="text-center">Esperando an√°lisis...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- M√©tricas -->
                    <div class="form-grid">
                        <div class="stats-card">
                            <h4>Productos Analizados</h4>
                            <div class="stats-number" id="metricProductosAnalizados">0</div>
                        </div>
                        <div class="stats-card">
                            <h4>En Riesgo</h4>
                            <div class="stats-number" id="metricProductosRiesgo">0</div>
                        </div>
                        <div class="stats-card">
                            <h4>Cr√≠ticos</h4>
                            <div class="stats-number" id="metricProductosCriticos">0</div>
                        </div>
                        <div class="stats-card">
                            <h4>√öltima An√°lisis</h4>
                            <div class="stats-number" style="font-size: 14px;" id="metricUltimaAnalisis">-</div>
                        </div>
                    </div>
                </div>

                <div class="form-grid mt-3">
                    <div class="stats-card">
                        <h4>Acciones R√°pidas</h4>
                        <div class="button-group">
                            <button class="btn btn-success" onclick="showSection('faltantes')">
                                ‚ö†Ô∏è Reportar Faltante
                            </button>
                            <button class="btn btn-primary" onclick="showSection('pendientes')">
                                üìã Ver Pedidos Pendientes
                            </button>
                            <button class="btn btn-warning" onclick="showSection('recepcion')">
                                üì• Recibir Pedidos
                            </button>
                        </div>
                    </div>
                    
                    <div class="stats-card">
                        <h4>Estado Actual</h4>
                        <div id="estadoActual">
                            <p>Sucursal: <strong id="sucursalActual"></strong></p>
                            <p>Usuario: <strong id="usuarioActual"></strong></p>
                            <p>√öltima actualizaci√≥n: <strong id="ultimaActualizacion"></strong></p>
                        </div>
                    </div>
                </div>

                <div id="alertasContainer" class="mt-3"></div>
            </section>

            <!-- FALTANTES -->
            <section id="faltantes" class="section">
                <div class="flex justify-between items-center mb-3">
                    <h2>‚ö†Ô∏è Reportar Faltante</h2>
                    <button class="btn btn-primary" onclick="limpiarFormularioFaltante()">
                        üîÑ Nuevo Faltante
                    </button>
                </div>

                <div class="alertas-container mb-3">
                    <strong>üìù ¬øC√≥mo reportar un faltante?</strong><br>
                    1. <strong>Escribe el producto</strong> - Si existe, se autocompletar√° todo autom√°ticamente<br>
                    2. <strong>Si no existe</strong> - Se mostrar√°n campos para crear producto nuevo<br>
                    3. <strong>Completa los datos</strong> - El sistema guarda producto y proveedor autom√°ticamente<br>
                    4. <strong>¬°Listo!</strong> - El faltante ya est√° pendiente para pedir
                </div>

                <div id="faltanteFormContainer" class="form-container">
                    <h3>üìù Reportar Nuevo Faltante</h3>
                    <form id="faltanteForm" onsubmit="guardarFaltante(event)">
                        <div class="form-group">
                            <label for="faltanteProducto">
                                <strong>1. ¬øQu√© producto falta? *</strong>
                            </label>
                            <div class="autocomplete-container">
                                <input type="text" id="faltanteProducto" class="form-control" 
                                       placeholder="Empieza a escribir el nombre del producto..." 
                                       autocomplete="off" required>
                                <div id="productoDropdown" class="autocomplete-list"></div>
                            </div>
                            <small class="text-muted">
                                Si el producto ya existe en el sistema, se autocompletar√° todo autom√°ticamente.
                            </small>
                        </div>

                        <div id="mensajeProducto" class="hidden" style="margin: 10px 0; padding: 10px; border-radius: 8px; background: #e3f2fd;">
                            <span id="textoMensaje"></span>
                        </div>

                        <div id="camposProductoExistente" class="hidden">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Proveedor</label>
                                    <input type="text" id="mostrarProveedor" class="form-control" readonly style="background: #f8f9fa;">
                                </div>
                                <div class="form-group">
                                    <label>Medio de Pedido</label>
                                    <input type="text" id="mostrarMedio" class="form-control" readonly style="background: #f8f9fa;">
                                </div>
                                <div class="form-group">
                                    <label>Contacto</label>
                                    <input type="text" id="mostrarContacto" class="form-control" readonly style="background: #f8f9fa;">
                                </div>
                            </div>
                        </div>

                        <div id="camposNuevoProducto" class="nuevo-producto-fields hidden">
                            <div class="nuevo-producto-header">
                                <span>‚ûï Producto Nuevo - Completa los datos</span>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="nuevoProveedor">Proveedor *</label>
                                    <select id="nuevoProveedor" class="form-control" onchange="actualizarDatosProveedorSeleccionado()">
                                        <option value="">Seleccionar proveedor...</option>
                                    </select>
                                    <button type="button" class="btn-nuevo-proveedor" onclick="abrirModalNuevoProveedorDesdeFaltante()">
                                        ‚ûï Agregar nuevo proveedor
                                    </button>
                                </div>
                                
                                <div id="datosProveedorSeleccionado" class="hidden" style="grid-column: span 2; background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <strong>üìã Datos del proveedor seleccionado:</strong><br>
                                    <div class="form-grid" style="margin-top: 10px;">
                                        <div class="form-group">
                                            <label>Medio de Pedido</label>
                                            <input type="text" id="mostrarMedioProveedor" class="form-control" readonly style="background: #ffffff;">
                                        </div>
                                        <div class="form-group">
                                            <label>Contacto/Link</label>
                                            <input type="text" id="mostrarContactoProveedor" class="form-control" readonly style="background: #ffffff;">
                                        </div>
                                    </div>
                                </div>
                                
                                <input type="hidden" id="nuevoMedio">
                                <input type="hidden" id="nuevoContacto">
                                <input type="hidden" id="nuevoLinkWeb">
                            </div>
                            
                            <div class="alertas-container" style="margin-top: 15px; padding: 10px; background: #e8f5e9;">
                                <strong>üí° Informaci√≥n:</strong> Este producto y proveedor se guardar√°n en la base de datos para futuros faltantes.
                            </div>
                        </div>

                        <div class="form-grid" style="margin-top: 20px;">
                            <div class="form-group">
                                <label for="faltanteCantidad">
                                    <strong>2. Cantidad *</strong>
                                </label>
                                <input type="number" id="faltanteCantidad" class="form-control" 
                                       value="1" min="1" max="100" required>
                                <small class="text-muted">¬øCu√°ntas unidades faltan?</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="faltanteStock">
                                    <strong>3. Estado del Stock *</strong>
                                </label>
                                <select id="faltanteStock" class="form-control" required>
                                    <option value="Quedan Pocos">üü° Quedan Pocos (reponer pronto)</option>
                                    <option value="Sin Stock">üî¥ Sin Stock (urgente)</option>
                                </select>
                                <small class="text-muted">Selecciona si a√∫n hay algunas unidades o ya no queda nada</small>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <label for="faltanteSucursal">
                                <strong>4. ¬øPara qu√© sucursal es el faltante? *</strong>
                            </label>
                            <select id="faltanteSucursal" class="form-control" required>
                            </select>
                            <small class="text-muted">Selecciona la sucursal donde falta el producto</small>
                        </div>

                        <input type="hidden" id="productoExistenteId">
                        <input type="hidden" id="productoExistenteProveedor">
                        <input type="hidden" id="productoExistenteMedio">
                        <input type="hidden" id="productoExistenteContacto">
                        <input type="hidden" id="productoExistenteLinkWeb">

                        <div class="button-group" style="margin-top: 30px;">
                            <button type="submit" class="btn btn-primary" style="padding: 15px 30px; font-size: 16px;">
                                ‚úÖ Guardar Faltante
                            </button>
                            <button type="button" class="btn" onclick="limpiarFormularioFaltante()">
                                üîÑ Nuevo Faltante
                            </button>
                        </div>
                    </form>
                </div>

                <div class="contador-faltantes mt-4">
                    <h3>üìä Faltantes Pendientes</h3>
                    <div class="contador-numero" id="contadorFaltantesPendientes">0</div>
                    <p>Productos esperando ser pedidos</p>
                    <button class="btn btn-success mt-2" onclick="showSection('pendientes')">
                        üìã Ver para generar pedidos
                    </button>
                </div>
            </section>

            <!-- PEDIDOS PENDIENTES -->
            <section id="pendientes" class="section">
                <div class="flex justify-between items-center mb-3">
                    <h2>üìã Pedidos Pendientes por Proveedor</h2>
                </div>

                <div class="alertas-container mb-3">
                    <strong>üìù ¬øC√≥mo funciona?</strong><br>
                    1. Se agrupan autom√°ticamente por proveedor<br>
                    2. Revisa los productos de cada proveedor<br>
                    3. Genera pedido individual<br>
                    4. Se abre WhatsApp/Web autom√°ticamente seg√∫n el medio
                </div>

                <div id="listaProveedoresPendientes" class="table-container">
                </div>

                <h3 class="mt-3">üïê Pedidos Recientes</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Proveedor</th>
                                <th>Productos</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="pedidosRecientesBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- RECEPCI√ìN -->
            <section id="recepcion" class="section">
                <div class="flex justify-between items-center mb-3">
                    <h2>üì• Recepci√≥n de Pedidos</h2>
                    <button class="btn btn-primary" onclick="actualizarRecepcion()">
                        üîÑ Actualizar
                    </button>
                </div>

                <div class="alertas-container mb-3">
                    <strong>üìã ¬øC√≥mo funciona la recepci√≥n?</strong><br>
                    1. <strong>Haz clic en "Ver Detalle"</strong> para ver todos los productos del pedido.<br>
                    2. <strong>Marca solo los productos</strong> que llegaron a TU sucursal.<br>
                    3. <strong>Confirma la recepci√≥n</strong> - Solo se cerrar√°n los faltantes de los productos marcados.<br>
                    4. Los productos para otras sucursales deben ser gestionados por cada sucursal por separado.
                </div>

                <div class="form-container">
                    <h3>Filtros</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="filterRecepcionProveedor">Proveedor</label>
                            <input type="text" id="filterRecepcionProveedor" class="form-control" 
                                   placeholder="Buscar proveedor..." oninput="filtrarRecepcion()">
                        </div>
                        <div class="form-group">
                            <label for="filterRecepcionEstado">Estado</label>
                            <select id="filterRecepcionEstado" class="form-control" onchange="filtrarRecepcion()">
                                <option value="En camino">En camino</option>
                                <option value="Recibido">Recibidos</option>
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filterRecepcionSucursal">Filtrar por sucursal</label>
                            <select id="filterRecepcionSucursal" class="form-control" onchange="filtrarRecepcion()">
                                <option value="">Todas las sucursales</option>
                                <option value="solo-mis-productos">Solo productos de mi sucursal</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha Pedido</th>
                                <th>Proveedor</th>
                                <th>Productos</th>
                                <th>Sucursales en el Pedido</th>
                                <th>Cantidad Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="recepcionTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- HISTORIAL -->
            <section id="historial" class="section">
                <h2>üì¶ Historial Completo de Pedidos</h2>
                
                <div class="form-container mb-3">
                    <h3>Filtros</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="filterFechaDesde">Desde</label>
                            <input type="date" id="filterFechaDesde" class="form-control" onchange="filtrarHistorial()">
                        </div>
                        <div class="form-group">
                            <label for="filterFechaHasta">Hasta</label>
                            <input type="date" id="filterFechaHasta" class="form-control" onchange="filtrarHistorial()">
                        </div>
                        <div class="form-group">
                            <label for="filterEstadoHistorial">Estado</label>
                            <select id="filterEstadoHistorial" class="form-control" onchange="filtrarHistorial()">
                                <option value="">Todos</option>
                                <option value="En camino">En camino</option>
                                <option value="Recibido">Recibido</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filterProveedorHistorial">Proveedor</label>
                            <input type="text" id="filterProveedorHistorial" class="form-control" 
                                   placeholder="Buscar proveedor..." oninput="filtrarHistorial()">
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Proveedor</th>
                                <th>Productos</th>
                                <th>Sucursales</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="historialBody">
                        </tbody>
                    </table>
                </div>

                <div class="form-container mt-3">
                    <h3>üìä Estad√≠sticas</h3>
                    <div class="form-grid">
                        <div class="stats-card">
                            <h4>Total Pedidos</h4>
                            <div class="stats-number" id="totalPedidos">0</div>
                        </div>
                        <div class="stats-card">
                            <h4>Pedidos Recibidos</h4>
                            <div class="stats-number" id="pedidosRecibidos">0</div>
                        </div>
                        <div class="stats-card">
                            <h4>Pedidos en Camino</h4>
                            <div class="stats-number" id="pedidosEnCamino">0</div>
                        </div>
                        <div class="stats-card">
                            <h4>Pedidos Cancelados</h4>
                            <div class="stats-number" id="pedidosCancelados">0</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CAT√ÅLOGO -->
            <section id="catalogo" class="section">
                <div class="faltantes-tabs">
                    <button class="faltantes-tab active" onclick="showCatalogoTab('productos')">
                        üì¶ Productos
                    </button>
                    <button class="faltantes-tab" onclick="showCatalogoTab('proveedores')">
                        üë• Proveedores
                    </button>
                </div>

                <div id="tab-productos-catalogo" class="tab-content active">
                    <div class="flex justify-between items-center mb-3">
                        <h3>üì¶ Gesti√≥n de Productos</h3>
                        <button class="btn btn-primary" onclick="mostrarFormularioProducto()">
                            + Nuevo Producto
                        </button>
                    </div>

                    <div id="productoFormContainer" class="form-container hidden">
                        <h4 id="productoFormTitle">Nuevo Producto</h4>
                        <form id="productoForm" onsubmit="guardarProducto(event)">
                            <input type="hidden" id="productoId">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="productoNombre">Producto *</label>
                                    <input type="text" id="productoNombre" class="form-control" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="productoProveedor">Proveedor *</label>
                                    <select id="productoProveedor" class="form-control" onchange="actualizarDatosProveedorCatalogo()">
                                        <option value="">Seleccionar proveedor...</option>
                                    </select>
                                    <button type="button" class="btn-nuevo-proveedor" onclick="abrirModalNuevoProveedor()">
                                        ‚ûï Agregar nuevo proveedor
                                    </button>
                                </div>
                                
                                <div id="datosProveedorCatalogo" class="hidden" style="grid-column: span 2; background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <strong>üìã Datos del proveedor seleccionado:</strong><br>
                                    <div class="form-grid" style="margin-top: 10px;">
                                        <div class="form-group">
                                            <label>Medio de Pedido</label>
                                            <input type="text" id="mostrarMedioCatalogo" class="form-control" readonly style="background: #ffffff;">
                                        </div>
                                        <div class="form-group">
                                            <label>Contacto/Link</label>
                                            <input type="text" id="mostrarContactoCatalogo" class="form-control" readonly style="background: #ffffff;">
                                        </div>
                                    </div>
                                </div>
                                
                                <input type="hidden" id="productoMedio">
                                <input type="hidden" id="productoContacto">
                                <input type="hidden" id="productoLinkWeb">
                            </div>
                            <div class="button-group">
                                <button type="submit" class="btn btn-primary">Guardar Producto</button>
                                <button type="button" class="btn" onclick="ocultarFormularioProducto()">Cancelar</button>
                            </div>
                        </form>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Proveedor</th>
                                    <th>Medio</th>
                                    <th>Contacto/Link</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="productosTableBody">
                            </tbody>
                        </table>
                    </div>

                    <div class="pagination-controls" id="paginationControls" style="display: none;">
                        <button class="btn-pagination" id="btnPrevPage" onclick="cargarPaginaAnterior()">
                            ‚Üê Anterior
                        </button>
                        <div class="page-info" id="pageInfo">
                            P√°gina <span id="currentPage">1</span> de <span id="totalPages">1</span>
                        </div>
                        <button class="btn-pagination" id="btnNextPage" onclick="cargarPaginaSiguiente()">
                            Siguiente ‚Üí
                        </button>
                    </div>

                    <div class="text-center mt-3" id="mobileLoadMore" style="display: none;">
                        <button class="btn btn-primary" onclick="cargarMasProductos()">
                            üì¶ Cargar m√°s productos
                        </button>
                    </div>
                </div>

                <div id="tab-proveedores-catalogo" class="tab-content">
                    <div class="flex justify-between items-center mb-3">
                        <h3>üë• Gesti√≥n de Proveedores</h3>
                        <button class="btn btn-primary" onclick="abrirModalNuevoProveedor()">
                            + Nuevo Proveedor
                        </button>
                    </div>

                    <div class="alertas-container mb-3">
                        <strong>üìã Gesti√≥n de Proveedores:</strong><br>
                        1. Los proveedores se pueden crear, editar y desactivar.<br>
                        2. Al seleccionar un proveedor en el formulario de productos, se cargar√°n autom√°ticamente sus datos.<br>
                        3. Los proveedores desactivados no aparecer√°n en las listas de selecci√≥n.
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Medio</th>
                                    <th>Contacto</th>
                                    <th>Link Web</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="proveedoresTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- CONFIGURACI√ìN -->
            <section id="configuracion" class="section">
                <h2>‚öôÔ∏è Configuraci√≥n del Sistema</h2>
                
                <div class="form-container">
                    <h3>üè™ Configuraci√≥n de Sucursal</h3>
                    <div class="form-group">
                        <label for="selectSucursalConfig">Sucursal Actual</label>
                            <select id="selectSucursalConfig" class="form-control" onchange="cambiarSucursalDesdeConfig()">
                        </select>
                    </div>
                    
                    <div class="alertas-container">
                        <strong>üí° Informaci√≥n:</strong> La sucursal seleccionada afecta a:<br>
                        ‚Ä¢ Dashboard (m√©tricas espec√≠ficas)<br>
                        ‚Ä¢ Formulario de faltantes (sucursal por defecto)<br>
                        ‚Ä¢ Recepci√≥n (filtro autom√°tico)
                    </div>
                </div>
                
                <!-- Configuraci√≥n de An√°lisis Local -->
                <div class="form-container mt-3">
                    <h3>üìä Configuraci√≥n de An√°lisis Local</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="analisisProfundidad">Profundidad del an√°lisis</label>
                            <select id="analisisProfundidad" class="form-control">
                                <option value="basico">B√°sico (r√°pido)</option>
                                <option value="completo" selected>Completo (recomendado)</option>
                                <option value="avanzado">Avanzado (detallado)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="autoAnalisis">
                                <input type="checkbox" id="autoAnalisis" disabled> An√°lisis autom√°tico
                            </label>
                            <small class="text-muted" style="color: #e74c3c;">‚ö†Ô∏è Deshabilitado para ahorrar recursos</small>
                        </div>
                    </div>
                    
                    <div class="button-group mt-3">
                        <button class="btn btn-primary" onclick="confirmarAnalisis()">
                            üîÑ Ejecutar An√°lisis Ahora
                        </button>
                        <button class="btn" onclick="mostrarReglasNegocio()">
                            üìã Ver Reglas de Negocio
                        </button>
                    </div>
                    
                    <div id="reglasNegocio" class="mt-3" style="display: none;">
                        <div class="alertas-container">
                            <h4>üìä Reglas de Negocio Aplicadas</h4>
                            <ul>
                                <li>üìà <strong>Alta rotaci√≥n</strong>: Productos pedidos m√°s de 2 veces por semana</li>
                                <li>‚ö†Ô∏è <strong>Cr√≠tico</strong>: Sin stock y alta rotaci√≥n</li>
                                <li>üîÑ <strong>Multi-sucursal</strong>: Productos necesarios en m√°s de una sucursal</li>
                                <li>üì¶ <strong>Stock de seguridad</strong>: Recomendado para alta rotaci√≥n</li>
                                <li>üè™ <strong>Coordinaci√≥n</strong>: Pedidos centralizados para m√∫ltiples sucursales</li>
                                <li>üîç <strong>Nuevos productos</strong>: Detecci√≥n de productos sin historial</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Monitoreo de Consumo Firebase -->
                <div class="form-container mt-3">
                    <h3>üìà Monitoreo de Consumo Firebase</h3>
                    
                    <div class="form-grid">
                        <div class="stats-card">
                            <h4>üìä Lecturas Diarias</h4>
                            <div class="stats-number" id="metricLecturasDiarias">0</div>
                            <div class="subtext" id="porcentajeLecturas">0% del l√≠mite</div>
                        </div>
                        <div class="stats-card">
                            <h4>üìù Escrituras Diarias</h4>
                            <div class="stats-number" id="metricEscriturasDiarias">0</div>
                            <div class="subtext" id="porcentajeEscrituras">0% del l√≠mite</div>
                        </div>
                        <div class="stats-card">
                            <h4>üóëÔ∏è Borrados Diarios</h4>
                            <div class="stats-number" id="metricBorradosDiarios">0</div>
                            <div class="subtext" id="porcentajeBorrados">0% del l√≠mite</div>
                        </div>
                        <div class="stats-card">
                            <h4>üì± Usuarios Activos</h4>
                            <div class="stats-number" id="metricUsuariosActivos">0</div>
                            <div class="subtext" id="estadoUsuarios">Hoy</div>
                        </div>
                    </div>
                    
                    <div class="alertas-container mt-3">
                        <h4>üìã L√≠mites del Plan Gratuito (Spark)</h4>
                        <table style="width: 100%;">
                            <tr>
                                <td><strong>Lecturas/d√≠a:</strong></td>
                                <td>50,000</td>
                                <td id="barraLecturas"><div style="height: 10px; background: #3498db; width: 0%; border-radius: 5px;"></div></td>
                            </tr>
                            <tr>
                                <td><strong>Escrituras/d√≠a:</strong></td>
                                <td>20,000</td>
                                <td id="barraEscrituras"><div style="height: 10px; background: #2ecc71; width: 0%; border-radius: 5px;"></div></td>
                            </tr>
                            <tr>
                                <td><strong>Borrados/d√≠a:</strong></td>
                                <td>20,000</td>
                                <td id="barraBorrados"><div style="height: 10px; background: #e74c3c; width: 0%; border-radius: 5px;"></div></td>
                            </tr>
                            <tr>
                                <td><strong>Usuarios/mes:</strong></td>
                                <td>10,000</td>
                                <td id="barraUsuarios"><div style="height: 10px; background: #f39c12; width: 0%; border-radius: 5px;"></div></td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="form-grid mt-3">
                        <div class="form-group">
                            <label for="consumoDetallado">Ver consumo detallado</label>
                            <select id="consumoDetallado" class="form-control" onchange="mostrarConsumoDetallado()">
                                <option value="hoy">Hoy</option>
                                <option value="semana">Esta semana</option>
                                <option value="mes">Este mes</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="detalleConsumo" class="mt-3">
                        <h4>üìä Desglose de Consumo</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Operaci√≥n</th>
                                        <th>Cantidad</th>
                                        <th>Porcentaje</th>
                                        <th>√öltima</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaConsumo">
                                    <tr><td colspan="4" class="text-center">Cargando datos de consumo...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="button-group mt-3">
                        <button class="btn btn-primary" onclick="actualizarMonitoreoConsumo()">
                            üîÑ Actualizar Monitoreo
                        </button>
                        <button class="btn btn-warning" onclick="resetearContadoresDiarios()">
                            üóìÔ∏è Resetear Contadores Diarios
                        </button>
                        <button class="btn" onclick="exportarReporteConsumo()">
                            üì§ Exportar Reporte
                        </button>
                    </div>
                </div>
                
                <div class="form-container mt-3">
                    <h3>üßπ Configuraci√≥n de Limpieza</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="diasLimpiezaConfig">D√≠as para mantener pedidos</label>
                            <input type="number" id="diasLimpiezaConfig" class="form-control" min="7" max="365" value="30">
                            <small class="text-muted">Los pedidos recibidos hace m√°s d√≠as ser√°n eliminados</small>
                        </div>
                        <div class="form-group">
                            <label for="autoLimpiezaConfig">
                                <input type="checkbox" id="autoLimpiezaConfig"> Limpieza autom√°tica
                            </label>
                            <small class="text-muted">Ejecutar limpieza autom√°ticamente al abrir la aplicaci√≥n</small>
                        </div>
                    </div>
                    
                    <div class="alertas-container mt-3">
                        <strong>üìä Estad√≠sticas actuales:</strong><br>
                        <div id="estadisticasConfigLimpieza">
                            Cargando...
                        </div>
                    </div>
                    
                    <div class="button-group mt-3">
                        <button class="btn btn-primary" onclick="guardarConfiguracion()">
                            üíæ Guardar Configuraci√≥n
                        </button>
                        <button class="btn btn-warning" onclick="ejecutarLimpiezaManual()">
                            üßπ Limpiar Ahora
                        </button>
                        <button class="btn" onclick="abrirModalConfigLimpieza()">
                            ‚öôÔ∏è Configuraci√≥n Avanzada
                        </button>
                    </div>
                </div>
                
                <div class="form-container mt-3">
                    <h3>üìä Informaci√≥n del Sistema</h3>
                    <div class="form-grid">
                        <div class="stats-card">
                            <h4>Total Productos</h4>
                            <div class="stats-number" id="totalProductosSistema">0</div>
                        </div>
                        <div class="stats-card">
                            <h4>Total Proveedores</h4>
                            <div class="stats-number" id="totalProveedoresSistema">0</div>
                        </div>
                        <div class="stats-card">
                            <h4>Total Faltantes</h4>
                            <div class="stats-number" id="totalFaltantesSistema">0</div>
                        </div>
                        <div class="stats-card">
                            <h4>Total Pedidos</h4>
                            <div class="stats-number" id="totalPedidosSistema">0</div>
                        </div>
                    </div>
                    
                    <div class="button-group mt-3">
                        <button class="btn" onclick="exportarDatos()">
                            üì§ Exportar Datos
                        </button>
                        <button class="btn btn-danger" onclick="limpiarCache()">
                            üóëÔ∏è Limpiar Cache
                        </button>
                    </div>
                </div>
                
                <div class="form-container mt-3">
                    <h3>‚ö†Ô∏è Borrar Base de Datos</h3>
                    <div class="alertas-container" style="background-color: #f8d7da; border-color: #f5c6cb; color: #721c24;">
                        <strong>‚ö†Ô∏è ADVERTENCIA:</strong> Esta acci√≥n borrar√° TODOS los datos de la base de datos (productos, proveedores, faltantes, pedidos, logs). Esta acci√≥n NO se puede deshacer.
                    </div>
                    <div class="form-group mt-3">
                        <label for="passwordBorrarDB">Contrase√±a de seguridad</label>
                        <input type="password" id="passwordBorrarDB" class="form-control" placeholder="Ingresa la contrase√±a para confirmar">
                    </div>
                    <button class="btn btn-danger mt-2" onclick="confirmarBorrarDB()">
                        üóëÔ∏è Borrar Toda la Base de Datos
                    </button>
                </div>
            </section>
        </div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURACI√ìN DE FIREBASE
        // ============================================================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyDIvu4JsAYAwccP9yTKERIzEtli2H86lSk",
            authDomain: "ferreteria-sistema.firebaseapp.com",
            projectId: "ferreteria-sistema",
            storageBucket: "ferreteria-sistema.firebasestorage.app",
            messagingSenderId: "122400105302",
            appId: "1:122400105302:web:589b241839d43d1971ecf7"
        };

        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            } else {
                firebase.app();
            }
        } catch (error) {
            console.log("Error inicializando Firebase:", error);
        }
        
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // ============================================================================
        // VARIABLES GLOBALES OPTIMIZADAS
        // ============================================================================
        let usuarioActual = null;
        let productos = [];
        let proveedores = [];
        let faltantes = [];
        let pedidos = [];
        let pedidoEnRevision = null;
        let nuevoProveedorDesde = null;
        let pedidoEnRecepcion = null;
        let procesandoPedido = false;
        
        // Variables para paginaci√≥n del cat√°logo
        let productosCatalogo = [];
        let currentPage = 1;
        let pageSize = 50;
        let totalProductos = 0;
        let lastVisibleProduct = null;
        let firstVisibleProduct = null;
        
        // Variables para autocompletado optimizado
        let autocompleteTimeout = null;
        let lastAutocompleteQuery = '';
        const AUTCOMPLETE_LIMIT = 20;
        
        // Configuraci√≥n
        const sucursales = ['Ferreter√≠a Carnevale', 'Ferreter√≠a Forza'];
        const mediosPedido = ['WhatsApp', 'Web', 'Manual'];
        const estadosFaltante = ['Pendiente', 'Pedido', 'Cerrado'];
        const estadosPedido = ['En camino', 'Recibido', 'Cancelado'];
        const estadosStock = ['Quedan Pocos', 'Sin Stock'];

        // ============================================================================
        // MONITOREO DE CONSUMO FIREBASE
        // ============================================================================
        let monitoreoConsumo = {
            lecturas: {
                hoy: 0,
                semana: {},
                mes: {},
                porOperacion: {}
            },
            escrituras: {
                hoy: 0,
                semana: {},
                mes: {},
                porOperacion: {}
            },
            borrados: {
                hoy: 0,
                semana: {},
                mes: {},
                porOperacion: {}
            },
            usuarios: {
                hoy: new Set(),
                semana: {},
                mes: {}
            },
            ultimaActualizacion: null
        };

        // Contadores de operaciones
        let contadorLecturas = 0;
        let contadorEscrituras = 0;
        let contadorBorrados = 0;

        // L√≠mites del plan gratuito
        const LIMITES_FIREBASE = {
            lecturasDiarias: 50000,
            escriturasDiarias: 20000,
            borradosDiarios: 20000,
            usuariosMensuales: 10000
        };

        function inicializarMonitoreoConsumo() {
            // Cargar datos de consumo guardados
            const datosGuardados = localStorage.getItem('monitoreoConsumo');
            if (datosGuardados) {
                try {
                    monitoreoConsumo = JSON.parse(datosGuardados);
                    
                    // Convertir Set de usuarios desde string
                    if (monitoreoConsumo.usuarios.hoy && Array.isArray(monitoreoConsumo.usuarios.hoy)) {
                        monitoreoConsumo.usuarios.hoy = new Set(monitoreoConsumo.usuarios.hoy);
                    } else {
                        monitoreoConsumo.usuarios.hoy = new Set();
                    }
                } catch (e) {
                    console.error('Error cargando monitoreo de consumo:', e);
                }
            }
            
            // Verificar si es un nuevo d√≠a
            const hoy = new Date().toISOString().split('T')[0];
            const ultimoDia = localStorage.getItem('ultimoDiaMonitoreo');
            
            if (ultimoDia !== hoy) {
                // Nuevo d√≠a, resetear contadores diarios
                monitoreoConsumo.lecturas.hoy = 0;
                monitoreoConsumo.escrituras.hoy = 0;
                monitoreoConsumo.borrados.hoy = 0;
                monitoreoConsumo.usuarios.hoy = new Set();
                localStorage.setItem('ultimoDiaMonitoreo', hoy);
                guardarMonitoreoConsumo();
            }
            
            // Configurar interceptores para contar operaciones
            configurarInterceptoresFirebase();
            
            // Actualizar UI del monitoreo
            actualizarUIMonitoreoConsumo();
        }

        function configurarInterceptoresFirebase() {
            // Interceptar operaciones de Firestore
            const originalGet = firebase.firestore.CollectionReference.prototype.get;
            const originalOnSnapshot = firebase.firestore.Query.prototype.onSnapshot;
            const originalAdd = firebase.firestore.CollectionReference.prototype.add;
            const originalSet = firebase.firestore.DocumentReference.prototype.set;
            const originalUpdate = firebase.firestore.DocumentReference.prototype.update;
            const originalDelete = firebase.firestore.DocumentReference.prototype.delete;
            
            // Interceptar lecturas (get)
            firebase.firestore.CollectionReference.prototype.get = async function(...args) {
                const result = await originalGet.apply(this, args);
                registrarLectura('collection_get', this._query ? 'query' : 'collection');
                return result;
            };
            
            // Interceptar listeners (onSnapshot)
            firebase.firestore.Query.prototype.onSnapshot = function(...args) {
                const unsubscribe = originalOnSnapshot.apply(this, args);
                registrarLectura('snapshot', 'listener');
                return unsubscribe;
            };
            
            // Interceptar escrituras (add)
            firebase.firestore.CollectionReference.prototype.add = async function(data) {
                const result = await originalAdd.apply(this, [data]);
                registrarEscritura('add', this._path.segments[this._path.segments.length - 1]);
                return result;
            };
            
            // Interceptar escrituras (set)
            firebase.firestore.DocumentReference.prototype.set = async function(data, options) {
                const result = await originalSet.apply(this, [data, options]);
                registrarEscritura('set', this._path.segments[this._path.segments.length - 2]);
                return result;
            };
            
            // Interceptar actualizaciones (update)
            firebase.firestore.DocumentReference.prototype.update = async function(data) {
                const result = await originalUpdate.apply(this, [data]);
                registrarEscritura('update', this._path.segments[this._path.segments.length - 2]);
                return result;
            };
            
            // Interceptar borrados (delete)
            firebase.firestore.DocumentReference.prototype.delete = async function(...args) {
                const result = await originalDelete.apply(this, args);
                registrarBorrado('delete', this._path.segments[this._path.segments.length - 2]);
                return result;
            };
        }

        function registrarLectura(operacion, coleccion) {
            contadorLecturas++;
            monitoreoConsumo.lecturas.hoy++;
            
            // Registrar por operaci√≥n
            const clave = `${operacion}_${coleccion}`;
            monitoreoConsumo.lecturas.porOperacion[clave] = 
                (monitoreoConsumo.lecturas.porOperacion[clave] || 0) + 1;
            
            // Actualizar cada 10 operaciones para no saturar
            if (contadorLecturas % 10 === 0) {
                guardarMonitoreoConsumo();
                actualizarUIMonitoreoConsumo();
            }
        }

        function registrarEscritura(operacion, coleccion) {
            contadorEscrituras++;
            monitoreoConsumo.escrituras.hoy++;
            
            const clave = `${operacion}_${coleccion}`;
            monitoreoConsumo.escrituras.porOperacion[clave] = 
                (monitoreoConsumo.escrituras.porOperacion[clave] || 0) + 1;
            
            if (contadorEscrituras % 5 === 0) {
                guardarMonitoreoConsumo();
                actualizarUIMonitoreoConsumo();
            }
        }

        function registrarBorrado(operacion, coleccion) {
            contadorBorrados++;
            monitoreoConsumo.borrados.hoy++;
            
            const clave = `${operacion}_${coleccion}`;
            monitoreoConsumo.borrados.porOperacion[clave] = 
                (monitoreoConsumo.borrados.porOperacion[clave] || 0) + 1;
            
            guardarMonitoreoConsumo();
            actualizarUIMonitoreoConsumo();
        }

        function registrarUsuario(email) {
            if (email && usuarioActual) {
                monitoreoConsumo.usuarios.hoy.add(email);
                
                const semana = getSemanaActual();
                const mes = getMesActual();
                
                monitoreoConsumo.usuarios.semana[semana] = 
                    monitoreoConsumo.usuarios.semana[semana] || new Set();
                monitoreoConsumo.usuarios.semana[semana].add(email);
                
                monitoreoConsumo.usuarios.mes[mes] = 
                    monitoreoConsumo.usuarios.mes[mes] || new Set();
                monitoreoConsumo.usuarios.mes[mes].add(email);
                
                guardarMonitoreoConsumo();
                actualizarUIMonitoreoConsumo();
            }
        }

        function guardarMonitoreoConsumo() {
            try {
                // Convertir Set a Array para guardar en localStorage
                const datosParaGuardar = {
                    ...monitoreoConsumo,
                    usuarios: {
                        hoy: Array.from(monitoreoConsumo.usuarios.hoy),
                        semana: Object.keys(monitoreoConsumo.usuarios.semana).reduce((acc, key) => {
                            acc[key] = Array.from(monitoreoConsumo.usuarios.semana[key]);
                            return acc;
                        }, {}),
                        mes: Object.keys(monitoreoConsumo.usuarios.mes).reduce((acc, key) => {
                            acc[key] = Array.from(monitoreoConsumo.usuarios.mes[key]);
                            return acc;
                        }, {})
                    }
                };
                
                localStorage.setItem('monitoreoConsumo', JSON.stringify(datosParaGuardar));
                monitoreoConsumo.ultimaActualizacion = new Date();
            } catch (e) {
                console.error('Error guardando monitoreo:', e);
            }
        }

        function actualizarUIMonitoreoConsumo() {
            // Actualizar m√©tricas principales
            document.getElementById('metricLecturasDiarias').textContent = 
                monitoreoConsumo.lecturas.hoy.toLocaleString();
            
            document.getElementById('metricEscriturasDiarias').textContent = 
                monitoreoConsumo.escrituras.hoy.toLocaleString();
            
            document.getElementById('metricBorradosDiarios').textContent = 
                monitoreoConsumo.borrados.hoy.toLocaleString();
            
            document.getElementById('metricUsuariosActivos').textContent = 
                monitoreoConsumo.usuarios.hoy.size;
            
            // Calcular porcentajes
            const porcentajeLecturas = (monitoreoConsumo.lecturas.hoy / LIMITES_FIREBASE.lecturasDiarias * 100).toFixed(1);
            const porcentajeEscrituras = (monitoreoConsumo.escrituras.hoy / LIMITES_FIREBASE.escriturasDiarias * 100).toFixed(1);
            const porcentajeBorrados = (monitoreoConsumo.borrados.hoy / LIMITES_FIREBASE.borradosDiarios * 100).toFixed(1);
            
            document.getElementById('porcentajeLecturas').textContent = `${porcentajeLecturas}% del l√≠mite`;
            document.getElementById('porcentajeEscrituras').textContent = `${porcentajeEscrituras}% del l√≠mite`;
            document.getElementById('porcentajeBorrados').textContent = `${porcentajeBorrados}% del l√≠mite`;
            document.getElementById('estadoUsuarios').textContent = `Hoy: ${monitoreoConsumo.usuarios.hoy.size}`;
            
            // Actualizar barras de progreso
            document.querySelector('#barraLecturas div').style.width = `${Math.min(porcentajeLecturas, 100)}%`;
            document.querySelector('#barraEscrituras div').style.width = `${Math.min(porcentajeEscrituras, 100)}%`;
            document.querySelector('#barraBorrados div').style.width = `${Math.min(porcentajeBorrados, 100)}%`;
            
            // Cambiar color si se acerca al l√≠mite
            if (porcentajeLecturas > 80) {
                document.querySelector('#barraLecturas div').style.background = '#e74c3c';
            } else if (porcentajeLecturas > 60) {
                document.querySelector('#barraLecturas div').style.background = '#f39c12';
            }
            
            if (porcentajeEscrituras > 80) {
                document.querySelector('#barraEscrituras div').style.background = '#e74c3c';
            } else if (porcentajeEscrituras > 60) {
                document.querySelector('#barraEscrituras div').style.background = '#f39c12';
            }
            
            // Actualizar tabla de consumo
            actualizarTablaConsumo();
        }

        function actualizarTablaConsumo() {
            const tabla = document.getElementById('tablaConsumo');
            if (!tabla) return;
            
            let html = '';
            
            // Lecturas por operaci√≥n
            Object.entries(monitoreoConsumo.lecturas.porOperacion)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .forEach(([operacion, cantidad]) => {
                    const [tipo, coleccion] = operacion.split('_');
                    html += `
                        <tr>
                            <td>üìñ ${coleccion} (${tipo})</td>
                            <td>${cantidad}</td>
                            <td>${((cantidad / monitoreoConsumo.lecturas.hoy) * 100).toFixed(1)}%</td>
                            <td>${formatearFecha(new Date())}</td>
                        </tr>
                    `;
                });
            
            // Escrituras por operaci√≥n
            Object.entries(monitoreoConsumo.escrituras.porOperacion)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .forEach(([operacion, cantidad]) => {
                    const [tipo, coleccion] = operacion.split('_');
                    html += `
                        <tr>
                            <td>üìù ${coleccion} (${tipo})</td>
                            <td>${cantidad}</td>
                            <td>${((cantidad / monitoreoConsumo.escrituras.hoy) * 100).toFixed(1)}%</td>
                            <td>${formatearFecha(new Date())}</td>
                        </tr>
                    `;
                });
            
            if (html === '') {
                html = '<tr><td colspan="4" class="text-center">No hay datos de consumo registrados</td></tr>';
            }
            
            tabla.innerHTML = html;
        }

        function mostrarConsumoDetallado() {
            const periodo = document.getElementById('consumoDetallado').value;
            // Implementar l√≥gica para mostrar consumo por periodo
            actualizarTablaConsumo();
        }

        function actualizarMonitoreoConsumo() {
            guardarMonitoreoConsumo();
            actualizarUIMonitoreoConsumo();
            mostrarNotificacion('Monitoreo de consumo actualizado', 'success');
        }

        function resetearContadoresDiarios() {
            if (confirm('¬øResetear contadores diarios de consumo?\n\nEsta acci√≥n no afecta los l√≠mites de Firebase.')) {
                monitoreoConsumo.lecturas.hoy = 0;
                monitoreoConsumo.escrituras.hoy = 0;
                monitoreoConsumo.borrados.hoy = 0;
                monitoreoConsumo.lecturas.porOperacion = {};
                monitoreoConsumo.escrituras.porOperacion = {};
                monitoreoConsumo.borrados.porOperacion = {};
                
                guardarMonitoreoConsumo();
                actualizarUIMonitoreoConsumo();
                mostrarNotificacion('Contadores diarios reseteados', 'success');
            }
        }

        function exportarReporteConsumo() {
            const reporte = {
                fecha: new Date().toISOString(),
                monitoreo: monitoreoConsumo,
                limites: LIMITES_FIREBASE,
                estadisticas: {
                    lecturasHoy: monitoreoConsumo.lecturas.hoy,
                    escriturasHoy: monitoreoConsumo.escrituras.hoy,
                    borradosHoy: monitoreoConsumo.borrados.hoy,
                    usuariosHoy: monitoreoConsumo.usuarios.hoy.size,
                    porcentajeUso: {
                        lecturas: (monitoreoConsumo.lecturas.hoy / LIMITES_FIREBASE.lecturasDiarias * 100).toFixed(1),
                        escrituras: (monitoreoConsumo.escrituras.hoy / LIMITES_FIREBASE.escriturasDiarias * 100).toFixed(1),
                        borrados: (monitoreoConsumo.borrados.hoy / LIMITES_FIREBASE.borradosDiarios * 100).toFixed(1)
                    }
                }
            };
            
            const datosJSON = JSON.stringify(reporte, null, 2);
            const blob = new Blob([datosJSON], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_consumo_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacion('Reporte de consumo exportado', 'success');
        }

        function getSemanaActual() {
            const hoy = new Date();
            const primerDia = new Date(hoy.setDate(hoy.getDate() - hoy.getDay()));
            return primerDia.toISOString().split('T')[0];
        }

        function getMesActual() {
            const hoy = new Date();
            return `${hoy.getFullYear()}-${(hoy.getMonth() + 1).toString().padStart(2, '0')}`;
        }

        // ============================================================================
        // SISTEMA DE LIMPIEZA DE PEDIDOS
        // ============================================================================
        let configLimpieza = {
            diasRetencion: 30,
            autoLimpieza: false
        };

        function cargarConfigLimpieza() {
            const configGuardada = localStorage.getItem('configLimpiezaPedidos');
            if (configGuardada) {
                try {
                    configLimpieza = JSON.parse(configGuardada);
                } catch (e) {
                    console.error('Error cargando configuraci√≥n de limpieza:', e);
                }
            }
            return configLimpieza;
        }

        // ============================================================================
        // CACH√â DE SUCURSAL (LOCALSTORAGE)
        // ============================================================================
        function cargarSucursalGuardada() {
            const sucursalGuardada = localStorage.getItem('sucursalFerreteria');
            if (sucursalGuardada && sucursales.includes(sucursalGuardada)) {
                return sucursalGuardada;
            }
            return sucursales[0];
        }

        function guardarSucursal(sucursal) {
            localStorage.setItem('sucursalFerreteria', sucursal);
            actualizarUISucursal();
        }

        function cambiarSucursal() {
            const sucursalActual = cargarSucursalGuardada();
            const indexActual = sucursales.indexOf(sucursalActual);
            const nuevaIndex = (indexActual + 1) % sucursales.length;
            guardarSucursal(sucursales[nuevaIndex]);
            mostrarNotificacion(`Sucursal cambiada a: ${sucursales[nuevaIndex]}`, 'success');
            actualizarDashboard();
            cargarPedidosPendientes();
            actualizarRecepcion();
        }

        function actualizarUISucursal() {
            const sucursal = cargarSucursalGuardada();
            document.getElementById('sucursalNombre').textContent = sucursal;
            document.getElementById('sucursalActual').textContent = sucursal;
            
            const selectFaltanteSucursal = document.getElementById('faltanteSucursal');
            if (selectFaltanteSucursal) {
                selectFaltanteSucursal.innerHTML = '';
                sucursales.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s;
                    option.textContent = s;
                    if (s === sucursal) option.selected = true;
                    selectFaltanteSucursal.appendChild(option);
                });
            }
            
            const filterRecepcionSucursal = document.getElementById('filterRecepcionSucursal');
            if (filterRecepcionSucursal) {
                const optionsHTML = `
                    <option value="">Todas las sucursales</option>
                    <option value="solo-mis-productos">Solo productos de mi sucursal</option>
                    ${sucursales.map(s => `<option value="${s}">${s}</option>`).join('')}
                `;
                filterRecepcionSucursal.innerHTML = optionsHTML;
            }
            
            const selectSucursalConfig = document.getElementById('selectSucursalConfig');
            if (selectSucursalConfig) {
                selectSucursalConfig.innerHTML = '';
                sucursales.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s;
                    option.textContent = s;
                    if (s === sucursal) option.selected = true;
                    selectSucursalConfig.appendChild(option);
                });
            }
        }

        // ============================================================================
        // FUNCIONES DE UTILIDAD
        // ============================================================================
        function mostrarLoading(mostrar = true, mensaje = '') {
            const overlay = document.getElementById('loadingOverlay');
            const mensajeElem = document.getElementById('loadingMessage');
            
            if (mensajeElem && mensaje) {
                mensajeElem.textContent = mensaje;
            }
            
            if (overlay) {
                if (mostrar) {
                    overlay.classList.add('active');
                } else {
                    overlay.classList.remove('active');
                }
            }
        }

        function mostrarNotificacion(mensaje, tipo = 'success', duracion = 5000) {
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            notification.innerHTML = `<span>${mensaje}</span>`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duracion);
        }

        function formatearFecha(fecha) {
            if (!fecha) return '-';
            if (fecha.toDate) {
                fecha = fecha.toDate();
            }
            return fecha.toLocaleDateString('es-AR') + ' ' + fecha.toLocaleTimeString('es-AR', {hour: '2-digit', minute:'2-digit'});
        }

        // ============================================================================
        // SISTEMA DE AN√ÅLISIS LOCAL MEJORADO - CON CONFIRMACI√ìN
        // ============================================================================

        // Funci√≥n para confirmar antes de ejecutar an√°lisis
        function confirmarAnalisis() {
            if (!confirm('‚ö†Ô∏è El an√°lisis inteligente consume recursos significativos de Firebase.\n\n‚Ä¢ Aproximadamente 500-700 lecturas por an√°lisis\n‚Ä¢ M√°ximo recomendado: 1 vez por hora\n\n¬øContinuar con el an√°lisis?')) {
                return;
            }
            
            // Verificar √∫ltimo an√°lisis
            const ultimoAnalisisKey = `ultimo_analisis_${usuarioActual?.email || 'anonimo'}`;
            const ultimoAnalisis = localStorage.getItem(ultimoAnalisisKey);
            
            if (ultimoAnalisis) {
                const unaHora = 60 * 60 * 1000;
                if (Date.now() - parseInt(ultimoAnalisis) < unaHora) {
                    if (!confirm('Ya ejecutaste un an√°lisis hace menos de 1 hora.\n\n¬øEst√°s seguro de que quieres ejecutar otro?')) {
                        return;
                    }
                }
            }
            
            // Guardar timestamp
            localStorage.setItem(ultimoAnalisisKey, Date.now().toString());
            
            // Ejecutar an√°lisis
            actualizarAnalisisLocal();
        }

        // 1. Preparar datos para an√°lisis - CON L√çMITES
        function prepararDatosParaAnalisis() {
            try {
                const sucursalActual = cargarSucursalGuardada();
                const ahora = new Date();
                const ultimos30Dias = new Date(ahora);
                ultimos30Dias.setDate(ultimos30Dias.getDate() - 30);
                
                // L√çMITES EXPL√çCITOS PARA REDUCIR CONSUMO
                const LIMITE_FALTANTES = 500; // Reducido de 500
                const LIMITE_PEDIDOS = 200;    // Reducido de 200
                
                // 1. Faltantes actuales con validaci√≥n
                const faltantesActuales = (faltantes || []).filter(f => {
                    if (!f) return false;
                    return f.sucursal === sucursalActual && 
                           f.estadoFaltante === 'Pendiente';
                }).slice(0, LIMITE_FALTANTES);
                
                // 2. Pedidos recientes con validaci√≥n robusta
                const pedidosRecientes = (pedidos || []).filter(p => {
                    if (!p || !p.fechaPedido) return false;
                    
                    try {
                        let fechaPedido;
                        if (p.fechaPedido && typeof p.fechaPedido.toDate === 'function') {
                            fechaPedido = p.fechaPedido.toDate();
                        } else if (p.fechaPedido) {
                            fechaPedido = new Date(p.fechaPedido);
                        } else {
                            return false;
                        }
                        
                        return fechaPedido >= ultimos30Dias;
                    } catch (error) {
                        console.warn("Error procesando fecha de pedido:", error);
                        return false;
                    }
                }).slice(0, LIMITE_PEDIDOS);
                
                // 3. Si no hay datos, retornar array vac√≠o
                if (faltantesActuales.length === 0 && pedidosRecientes.length === 0) {
                    return [];
                }
                
                // Agrupar datos por producto
                const productosMap = {};
                
                // Agregar faltantes actuales
                faltantesActuales.forEach(f => {
                    const clave = `${f.producto}|${f.proveedor}`;
                    if (!productosMap[clave]) {
                        productosMap[clave] = {
                            producto: f.producto,
                            proveedor: f.proveedor,
                            estadoStock: f.estadoStock,
                            cantidadFaltante: 0,
                            vecesPedido30Dias: 0,
                            cantidadTotalPedida: 0,
                            ultimoPedido: null,
                            sucursales: new Set()
                        };
                    }
                    productosMap[clave].cantidadFaltante += f.cantidad || 1;
                    productosMap[clave].sucursales.add(f.sucursal);
                });
                
                // Agregar datos hist√≥ricos de pedidos
                pedidosRecientes.forEach(pedido => {
                    if (pedido.productos && Array.isArray(pedido.productos)) {
                        pedido.productos.slice(0, 20).forEach(item => {
                            const clave = `${item.producto}|${pedido.proveedor}`;
                            if (!productosMap[clave]) {
                                productosMap[clave] = {
                                    producto: item.producto,
                                    proveedor: pedido.proveedor,
                                    estadoStock: 'Desconocido',
                                    cantidadFaltante: 0,
                                    vecesPedido30Dias: 0,
                                    cantidadTotalPedida: 0,
                                    ultimoPedido: pedido.fechaPedido,
                                    sucursales: new Set()
                                };
                            }
                            
                            productosMap[clave].vecesPedido30Dias += 1;
                            productosMap[clave].cantidadTotalPedida += item.cantidad || 1;
                            productosMap[clave].ultimoPedido = pedido.fechaPedido;
                            if (item.sucursal) productosMap[clave].sucursales.add(item.sucursal);
                        });
                    }
                });
                
                // Convertir a array y calcular m√©tricas
                const productosAnalizados = Object.values(productosMap)
                    .slice(0, 50)
                    .map(p => {
                        // Calcular frecuencia de pedido (veces por semana)
                        const frecuenciaSemanal = (p.vecesPedido30Dias / 4.3).toFixed(1);
                        
                        // Calcular riesgo basado en m√∫ltiples factores
                        let nivelRiesgo = 'BAJO';
                        let puntuacion = 0;
                        
                        if (p.cantidadFaltante > 0) puntuacion += 3;
                        if (p.estadoStock === 'Sin Stock') puntuacion += 4;
                        if (p.vecesPedido30Dias >= 3) puntuacion += 2;
                        if (parseFloat(frecuenciaSemanal) > 2) puntuacion += 1;
                        
                        if (puntuacion >= 6) nivelRiesgo = 'CR√çTICO';
                        else if (puntuacion >= 4) nivelRiesgo = 'ALTO';
                        else if (puntuacion >= 2) nivelRiesgo = 'MEDIO';
                        
                        return {
                            ...p,
                            frecuenciaSemanal: frecuenciaSemanal,
                            nivelRiesgo: nivelRiesgo,
                            puntuacionRiesgo: puntuacion,
                            sucursales: Array.from(p.sucursales)
                        };
                    });
                
                // Ordenar por nivel de riesgo
                return productosAnalizados.sort((a, b) => b.puntuacionRiesgo - a.puntuacionRiesgo);
                
            } catch (error) {
                console.error("Error en prepararDatosParaAnalisis:", error);
                return [];
            }
        }

        // 2. AN√ÅLISIS LOCAL MEJORADO CON REGLAS DE NEGOCIO
        function crearAnalisisLocal(datosAnalisis) {
            // Validar datos de entrada
            if (!datosAnalisis || datosAnalisis.length === 0) {
                return {
                    productosCriticos: [],
                    recomendaciones: ['‚ö†Ô∏è No hay datos suficientes para el an√°lisis'],
                    tendencias: [],
                    resumen: 'Sin datos para an√°lisis',
                    datosLocales: {
                        totalProductosAnalizados: 0,
                        productosConRiesgo: 0,
                        productosCriticosCount: 0,
                        ultimaActualizacion: new Date().toLocaleString('es-AR'),
                        metricas: {
                            criticos: 0,
                            altaRotacion: 0,
                            multiSucursal: 0,
                            sinMovimiento: 0
                        }
                    }
                };
            }
            
            // Agrupar productos por categor√≠a
            const productosPorCategoria = {};
            
            datosAnalisis.forEach(producto => {
                // Detectar categor√≠a por palabras clave
                let categoria = 'General';
                const nombre = producto.producto ? producto.producto.toLowerCase() : '';
                
                // Reglas de categorizaci√≥n para ferreter√≠a
                if (nombre.includes('martillo') || nombre.includes('destornillador') || nombre.includes('llave') || nombre.includes('herramienta')) {
                    categoria = 'Herramientas Manuales';
                } else if (nombre.includes('pintura') || nombre.includes('brocha') || nombre.includes('rodillo') || nombre.includes('solvente')) {
                    categoria = 'Pinturer√≠a';
                } else if (nombre.includes('tuerca') || nombre.includes('tornillo') || nombre.includes('clavo') || nombre.includes('perno')) {
                    categoria = 'Fijaciones';
                } else if (nombre.includes('cable') || nombre.includes('enchufe') || nombre.includes('el√©ctrico') || nombre.includes('interruptor')) {
                    categoria = 'El√©ctricos';
                } else if (nombre.includes('tubo') || nombre.includes('ca√±o') || nombre.includes('grifo') || nombre.includes('llave')) {
                    categoria = 'Plomer√≠a';
                } else if (nombre.includes('cerradura') || nombre.includes('bisagra') || nombre.includes('picaporte')) {
                    categoria = 'Cerrajer√≠a';
                }
                
                if (!productosPorCategoria[categoria]) {
                    productosPorCategoria[categoria] = [];
                }
                productosPorCategoria[categoria].push(producto);
            });
            
            // Calcular tendencias por categor√≠a
            const tendencias = Object.keys(productosPorCategoria).map(categoria => {
                const productos = productosPorCategoria[categoria];
                const criticos = productos.filter(p => p.nivelRiesgo === 'CR√çTICO').length;
                const total = productos.length;
                const porcentaje = total > 0 ? Math.round((criticos / total) * 100) : 0;
                
                let tendencia = 'ESTABLE';
                if (porcentaje > 30) tendencia = 'AUMENTO';
                else if (porcentaje > 10) tendencia = 'LEVE AUMENTO';
                else if (porcentaje === 0) tendencia = 'DISMINUCI√ìN';
                
                return {
                    categoria,
                    tendencia: tendencia,
                    observacion: `${criticos} de ${total} productos (${porcentaje}%) requieren atenci√≥n en ${categoria}`
                };
            });
            
            // Productos cr√≠ticos con reglas de negocio inteligentes
            const productosCriticos = datosAnalisis
                .filter(p => p.nivelRiesgo === 'CR√çTICO' || p.nivelRiesgo === 'ALTO')
                .slice(0, 8)
                .map(p => {
                    // Determinar acci√≥n basada en m√∫ltiples factores
                    let accion = 'Reponer normalmente';
                    let prioridad = 'MEDIA';
                    let motivo = '';
                    
                    if (p.estadoStock === 'Sin Stock' && parseFloat(p.frecuenciaSemanal) > 2) {
                        accion = 'URGENTE: Reponer inmediatamente - Producto de alta rotaci√≥n sin stock';
                        prioridad = 'ALTA';
                        motivo = 'Sin stock + Alta rotaci√≥n';
                    } else if (p.estadoStock === 'Sin Stock') {
                        accion = 'Reponer pronto - Sin stock actual';
                        prioridad = 'ALTA';
                        motivo = 'Sin stock';
                    } else if (parseFloat(p.frecuenciaSemanal) > 3) {
                        accion = 'Aumentar stock de seguridad - Muy alta demanda';
                        prioridad = 'ALTA';
                        motivo = 'Demanda muy alta';
                    } else if (p.cantidadFaltante > 10) {
                        accion = 'Pedir cantidad mayor - Gran faltante';
                        prioridad = 'ALTA';
                        motivo = 'Gran cantidad faltante';
                    } else if (p.vecesPedido30Dias === 0 && p.cantidadFaltante > 0) {
                        accion = 'Primer pedido - Nuevo producto faltante';
                        prioridad = 'MEDIA';
                        motivo = 'Producto nuevo';
                    } else if (parseFloat(p.frecuenciaSemanal) > 2) {
                        accion = 'Establecer stock m√≠nimo - Alta rotaci√≥n';
                        prioridad = 'MEDIA';
                        motivo = 'Alta rotaci√≥n';
                    } else if (p.sucursales.length > 1) {
                        accion = 'Coordinar con otras sucursales';
                        prioridad = 'MEDIA';
                        motivo = 'M√∫ltiples sucursales';
                    }
                    
                    return {
                        producto: p.producto || 'Sin nombre',
                        proveedor: p.proveedor || 'Sin proveedor',
                        motivo: motivo || `${p.estadoStock || 'Desconocido'} | ${p.vecesPedido30Dias} pedidos/30d√≠as`,
                        accionRecomendada: accion,
                        prioridad: prioridad,
                        datos: p
                    };
                });
            
            // Recomendaciones inteligentes basadas en patrones
            const recomendaciones = [];
            
            // An√°lisis de patrones de compra
            const productosSinMovimiento = datosAnalisis.filter(p => p.vecesPedido30Dias === 0 && p.cantidadFaltante > 0);
            if (productosSinMovimiento.length > 5) {
                recomendaciones.push(`‚ö†Ô∏è ${productosSinMovimiento.length} productos nuevos sin historial de pedidos. Considerar pedido de prueba.`);
            }
            
            const productosAltaRotacion = datosAnalisis.filter(p => parseFloat(p.frecuenciaSemanal) > 2);
            if (productosAltaRotacion.length > 0) {
                recomendaciones.push(`üìà ${productosAltaRotacion.length} productos de alta rotaci√≥n (m√°s de 2 veces/semana). Considerar stock de seguridad.`);
            }
            
            const productosMultiSucursal = datosAnalisis.filter(p => p.sucursales.length > 1);
            if (productosMultiSucursal.length > 0) {
                recomendaciones.push(`üè™ ${productosMultiSucursal.length} productos necesarios en m√∫ltiples sucursales. Coordinar pedido centralizado.`);
            }
            
            const productosCriticosCount = datosAnalisis.filter(p => p.nivelRiesgo === 'CR√çTICO').length;
            if (productosCriticosCount > 5) {
                recomendaciones.push(`üö® ${productosCriticosCount} productos en estado CR√çTICO. Revisi√≥n urgente del inventario.`);
            }
            
            
            // An√°lisis de categor√≠as con problemas
            const categoriasCriticas = tendencias.filter(t => t.tendencia === 'AUMENTO' || t.tendencia === 'LEVE AUMENTO');
            if (categoriasCriticas.length > 0) {
                recomendaciones.push(`üì¶ Atenci√≥n especial a: ${categoriasCriticas.map(c => c.categoria).join(', ')}`);
            }
            
            return {
                productosCriticos: productosCriticos,
                recomendaciones: recomendaciones,
                tendencias: tendencias,
                resumen: `An√°lisis local avanzado: ${datosAnalisis.length} productos analizados, ${productosCriticos.length} requieren atenci√≥n`,
                datosLocales: {
                    totalProductosAnalizados: datosAnalisis.length,
                    productosConRiesgo: datosAnalisis.filter(p => p.nivelRiesgo !== 'BAJO').length,
                    productosCriticosCount: productosCriticosCount,
                    ultimaActualizacion: new Date().toLocaleString('es-AR') + " (an√°lisis local mejorado)",
                    metricas: {
                        criticos: productosCriticos.length,
                        altaRotacion: productosAltaRotacion.length,
                        multiSucursal: productosMultiSucursal.length,
                        sinMovimiento: productosSinMovimiento.length
                    }
                }
            };
        }

        // 3. Funci√≥n para actualizar el an√°lisis local
        function actualizarAnalisisLocal() {
            const btn = document.getElementById('btnAnalizarInventario');
            if (!btn) {
                console.error("Bot√≥n de an√°lisis no encontrado");
                return;
            }
            
            const textoOriginal = btn.innerHTML;
            
            try {
                btn.innerHTML = '‚è≥ Analizando...';
                btn.disabled = true;
                
                // Mostrar estado de carga
                document.getElementById('resumenAnalisis').innerHTML = `
                    <div class="text-center">
                        <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto;"></div>
                        <p class="mt-2">üìä Analizando inventario...</p>
                    </div>
                `;
                
                // Verificar que haya datos
                if (!faltantes || faltantes.length === 0) {
                    mostrarResultadosAnalisis({
                        productosCriticos: [],
                        recomendaciones: ['‚ö†Ô∏è No hay faltantes registrados para analizar'],
                        tendencias: [],
                        resumen: 'Sin datos para an√°lisis',
                        datosLocales: {
                            totalProductosAnalizados: 0,
                            ultimaActualizacion: new Date().toLocaleString('es-AR')
                        }
                    });
                    return;
                }
                
                // Ejecutar an√°lisis
                const datosAnalisis = prepararDatosParaAnalisis();
                
                if (!datosAnalisis || datosAnalisis.length === 0) {
                    mostrarResultadosAnalisis({
                        productosCriticos: [],
                        recomendaciones: ['üìä No hay datos suficientes para el an√°lisis'],
                        tendencias: [],
                        resumen: 'Datos insuficientes',
                        datosLocales: {
                            totalProductosAnalizados: 0,
                            ultimaActualizacion: new Date().toLocaleString('es-AR')
                        }
                    });
                    return;
                }
                
                const analisis = crearAnalisisLocal(datosAnalisis);
                mostrarResultadosAnalisis(analisis);
                
                // Guardar en cache local
                try {
                    localStorage.setItem('ultimoAnalisisInventario', JSON.stringify({
                        datos: analisis,
                        fecha: new Date().toISOString(),
                        ejecutadoPor: usuarioActual?.email || 'An√≥nimo'
                    }));
                } catch (e) {
                    console.warn("No se pudo guardar en cache:", e);
                }
                
                mostrarNotificacion('‚úÖ An√°lisis de inventario completado', 'success');
                
            } catch (error) {
                console.error("Error cr√≠tico en an√°lisis local:", error);
                mostrarNotificacion('‚ùå Error en el an√°lisis local', 'error');
                
                // Mostrar estado de error
                mostrarResultadosAnalisis({
                    productosCriticos: [],
                    recomendaciones: ['üö® Error t√©cnico en el an√°lisis', 'Por favor, recarga la p√°gina'],
                    tendencias: [],
                    resumen: 'Error en an√°lisis',
                    datosLocales: {
                        totalProductosAnalizados: 0,
                        ultimaActualizacion: 'Error'
                    }
                });
                
            } finally {
                btn.innerHTML = textoOriginal;
                btn.disabled = false;
            }
        }

        // 4. Funci√≥n para mostrar resultados del an√°lisis
        function mostrarResultadosAnalisis(analisis) {
            // Validar que el an√°lisis tenga la estructura correcta
            if (!analisis) {
                analisis = {
                    productosCriticos: [],
                    recomendaciones: ['‚ö†Ô∏è No se pudo generar el an√°lisis'],
                    tendencias: [],
                    resumen: 'Error en el an√°lisis',
                    datosLocales: {
                        totalProductosAnalizados: 0,
                        productosConRiesgo: 0,
                        productosCriticosCount: 0,
                        ultimaActualizacion: new Date().toLocaleString('es-AR')
                    }
                };
            }
            
            // 1. Mostrar resumen ejecutivo
            const resumenDiv = document.getElementById('resumenAnalisis');
            if (resumenDiv) {
                resumenDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 style="margin: 0;">${analisis.resumen || 'An√°lisis de inventario'}</h4>
                            <small>√öltima actualizaci√≥n: ${analisis.datosLocales?.ultimaActualizacion || new Date().toLocaleString('es-AR')}</small>
                        </div>
                        <span class="badge ${analisis.datosLocales?.productosConRiesgo > 5 ? 'badge-urgente' : 'badge-en-camino'}">
                            ${analisis.datosLocales?.productosConRiesgo || 0} productos requieren atenci√≥n
                        </span>
                    </div>
                `;
            }
            
            // 2. Mostrar productos cr√≠ticos
            const tablaCriticos = document.getElementById('tablaProductosCriticos');
            if (tablaCriticos) {
                if (analisis.productosCriticos && analisis.productosCriticos.length > 0) {
                    let html = '';
                    analisis.productosCriticos.forEach(producto => {
                        const clasePrioridad = producto.prioridad === 'ALTA' ? 'badge-alta' : 
                                              producto.prioridad === 'MEDIA' ? 'badge-media' : 'badge-baja';
                        
                        html += `
                            <tr class="${producto.prioridad === 'ALTA' ? 'producto-critico' : 'producto-alto'}">
                                <td><strong>${producto.producto}</strong><br><small>${producto.proveedor}</small></td>
                                <td>${producto.motivo || 'Riesgo detectado'}</td>
                                <td>${producto.accionRecomendada || 'Revisar stock'}</td>
                                <td><span class="badge-prioridad ${clasePrioridad}">${producto.prioridad || 'MEDIA'}</span></td>
                            </tr>
                        `;
                    });
                    tablaCriticos.innerHTML = html;
                } else {
                    tablaCriticos.innerHTML = '<tr><td colspan="4" class="text-center">‚úÖ No hay productos cr√≠ticos detectados</td></tr>';
                }
            }
            
            // 3. Mostrar recomendaciones
            const listaRecomendaciones = document.getElementById('recomendacionesLista');
            if (listaRecomendaciones) {
                if (analisis.recomendaciones && analisis.recomendaciones.length > 0) {
                    let html = '';
                    analisis.recomendaciones.forEach(rec => {
                        html += `<li>${rec}</li>`;
                    });
                    listaRecomendaciones.innerHTML = html;
                } else {
                    listaRecomendaciones.innerHTML = '<li>No hay recomendaciones espec√≠ficas en este momento</li>';
                }
            }
            
            // 4. Mostrar tendencias
            const tablaTendencias = document.getElementById('tablaTendencias');
            if (tablaTendencias) {
                if (analisis.tendencias && analisis.tendencias.length > 0) {
                    let html = '';
                    analisis.tendencias.forEach(tendencia => {
                        const badgeTendencia = tendencia.tendencia === 'AUMENTO' ? 'badge-urgente' :
                                              tendencia.tendencia === 'LEVE AUMENTO' ? 'badge-pendiente' :
                                              tendencia.tendencia === 'DISMINUCI√ìN' ? 'badge-recibido' : 'badge-en-camino';
                        
                        html += `
                            <tr>
                                <td><strong>${tendencia.categoria || 'General'}</strong></td>
                                <td><span class="badge ${badgeTendencia}">${tendencia.tendencia || 'ESTABLE'}</span></td>
                                <td>${tendencia.observacion || 'Sin observaciones espec√≠ficas'}</td>
                            </tr>
                        `;
                    });
                    tablaTendencias.innerHTML = html;
                } else {
                    tablaTendencias.innerHTML = '<tr><td colspan="3" class="text-center">üìä No hay tendencias claras detectadas</td></tr>';
                }
            }
            
            // 5. Actualizar m√©tricas
            const metricas = [
                { id: 'metricProductosAnalizados', valor: analisis.datosLocales?.totalProductosAnalizados || 0 },
                { id: 'metricProductosRiesgo', valor: analisis.datosLocales?.productosConRiesgo || 0 },
                { id: 'metricProductosCriticos', valor: (analisis.productosCriticos || []).length },
                { id: 'metricUltimaAnalisis', valor: new Date().toLocaleTimeString('es-AR', {hour: '2-digit', minute:'2-digit'}) }
            ];
            
            metricas.forEach(metrica => {
                const elem = document.getElementById(metrica.id);
                if (elem) {
                    if (metrica.id === 'metricUltimaAnalisis') {
                        elem.textContent = metrica.valor;
                    } else {
                        elem.textContent = metrica.valor;
                    }
                }
            });
        }

        // 5. Cargar an√°lisis desde cache
        function cargarAnalisisDesdeCache() {
            try {
                const cache = localStorage.getItem('ultimoAnalisisInventario');
                if (cache) {
                    const { datos, fecha } = JSON.parse(cache);
                    const fechaCache = new Date(fecha);
                    const ahora = new Date();
                    const diferenciaHoras = (ahora - fechaCache) / (1000 * 60 * 60);
                    
                    // Si el cache tiene menos de 2 horas, usarlo
                    if (diferenciaHoras < 2) {
                        mostrarResultadosAnalisis(datos);
                        return true;
                    }
                }
            } catch (error) {
                console.error("Error cargando cache:", error);
            }
            return false;
        }

        // Funci√≥n auxiliar para mostrar reglas de negocio
        function mostrarReglasNegocio() {
            const div = document.getElementById('reglasNegocio');
            if (div.style.display === 'none') {
                div.style.display = 'block';
            } else {
                div.style.display = 'none';
            }
        }

        // ============================================================================
        // PESTA√ëAS DEL CAT√ÅLOGO
        // ============================================================================
        function showCatalogoTab(tabId) {
            document.querySelectorAll('.faltantes-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const tabButtons = document.querySelectorAll('.faltantes-tab');
            tabButtons.forEach(button => {
                if (button.textContent.includes(tabId === 'productos' ? 'Productos' : 'Proveedores')) {
                    button.classList.add('active');
                }
            });
            
            const tabContent = document.getElementById(`tab-${tabId}-catalogo`);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            if (tabId === 'productos') {
                cargarCatalogoProductos();
            } else if (tabId === 'proveedores') {
                actualizarListaProveedores();
            }
        }

        // ============================================================================
        // AUTENTICACI√ìN
        // ============================================================================
        function showLoginTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.login-form').forEach(f => f.classList.add('hidden'));
            
            if (tab === 'login') {
                document.querySelector('.login-tab:nth-child(1)').classList.add('active');
                document.getElementById('loginForm').classList.remove('hidden');
            } else {
                document.querySelector('.login-tab:nth-child(2)').classList.add('active');
                document.getElementById('registerForm').classList.remove('hidden');
            }
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            mostrarLoading(true, 'Iniciando sesi√≥n...');
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                usuarioActual = userCredential.user;
                
                console.log('Usuario autenticado:', usuarioActual.email);
                mostrarNotificacion('Sesi√≥n iniciada correctamente');
                inicializarApp();
                
            } catch (error) {
                console.error('Error en login:', error);
                let mensajeError = 'Error al iniciar sesi√≥n';
                if (error.code === 'auth/user-not-found') {
                    mensajeError = 'Usuario no encontrado';
                } else if (error.code === 'auth/wrong-password') {
                    mensajeError = 'Contrase√±a incorrecta';
                } else if (error.code === 'auth/invalid-email') {
                    mensajeError = 'Email inv√°lido';
                } else if (error.code === 'auth/network-request-failed') {
                    mensajeError = 'Error de conexi√≥n. Verifica tu internet';
                }
                mostrarNotificacion(mensajeError, 'error');
            } finally {
                mostrarLoading(false);
            }
        });

        // Registro
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nombre = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (password !== confirmPassword) {
                mostrarNotificacion('Las contrase√±as no coinciden', 'error');
                return;
            }
            
            if (password.length < 6) {
                mostrarNotificacion('La contrase√±a debe tener al menos 6 caracteres', 'error');
                return;
            }
            
            mostrarLoading(true, 'Creando cuenta...');
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                usuarioActual = userCredential.user;
                
                await db.collection('usuarios').doc(usuarioActual.uid).set({
                    email: usuarioActual.email,
                    nombre: nombre,
                    rol: 'usuario',
                    fechaRegistro: firebase.firestore.FieldValue.serverTimestamp(),
                    sucursal: cargarSucursalGuardada()
                });
                
                mostrarNotificacion('Cuenta creada correctamente');
                inicializarApp();
                
            } catch (error) {
                console.error('Error en registro:', error);
                let mensajeError = 'Error al crear cuenta';
                if (error.code === 'auth/email-already-in-use') {
                    mensajeError = 'El email ya est√° en uso';
                } else if (error.code === 'auth/weak-password') {
                    mensajeError = 'La contrase√±a es muy d√©bil';
                } else if (error.code === 'auth/invalid-email') {
                    mensajeError = 'Email inv√°lido';
                }
                mostrarNotificacion(mensajeError, 'error');
            } finally {
                mostrarLoading(false);
            }
        });

        async function verificarUsuarioEnFirestore(user) {
            try {
                const userDoc = await db.collection('usuarios').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    await db.collection('usuarios').doc(user.uid).set({
                        email: user.email,
                        nombre: user.email.split('@')[0],
                        rol: 'usuario',
                        fechaRegistro: firebase.firestore.FieldValue.serverTimestamp(),
                        sucursal: cargarSucursalGuardada()
                    });
                }
                
                return userDoc;
            } catch (error) {
                console.error('Error verificando usuario:', error);
                return null;
            }
        }

        function logout() {
            mostrarLoading(true, 'Cerrando sesi√≥n...');
            auth.signOut().then(() => {
                usuarioActual = null;
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
                mostrarNotificacion('Sesi√≥n cerrada correctamente');
            }).catch(error => {
                console.error('Error al cerrar sesi√≥n:', error);
                mostrarNotificacion('Error al cerrar sesi√≥n', 'error');
            }).finally(() => {
                mostrarLoading(false);
            });
        }

        // Observador de autenticaci√≥n
        auth.onAuthStateChanged(async (user) => {
            console.log('Estado de autenticaci√≥n cambiado:', user ? 'Usuario activo' : 'No hay usuario');
            
            if (user) {
                usuarioActual = user;
                try {
                    await verificarUsuarioEnFirestore(user);
                    inicializarApp();
                } catch (error) {
                    console.error('Error inicializando app:', error);
                    mostrarNotificacion('Error cargando datos del usuario', 'error');
                }
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
            }
        });

        // ============================================================================
        // INICIALIZACI√ìN DE LA APLICACI√ìN (MODIFICADA - SIN AN√ÅLISIS AUTOM√ÅTICO)
        // ============================================================================
        function inicializarApp() {
            console.log('Inicializando app para usuario:', usuarioActual.email);
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('userEmail').textContent = usuarioActual.email;
            document.getElementById('usuarioActual').textContent = usuarioActual.email;
            document.getElementById('ultimaActualizacion').textContent = new Date().toLocaleTimeString();
            
            actualizarUISucursal();
            
            // Registrar usuario en monitoreo
            registrarUsuario(usuarioActual.email);
            
            // Inicializar monitoreo de consumo
            //inicializarMonitoreoConsumo();
            
            cargarProductosOptimizado();
            cargarProveedores();
            cargarFaltantes();
            cargarPedidos();
            
            configurarListenersTiempoReal();
            
            cargarConfigLimpieza();
            
            // An√°lisis local - SOLO cargar cache si existe
            console.log('Sistema de an√°lisis local activado (manual)');
            
            // NO ejecutar an√°lisis autom√°ticamente, solo cargar cache si existe
            if (document.getElementById('dashboard').classList.contains('active')) {
                cargarAnalisisDesdeCache();
            }
            
            // Si la secci√≥n de historial est√° activa, cargarla
            if (document.getElementById('historial').classList.contains('active')) {
                cargarHistorial();
            }
            
            mostrarNotificacion('Aplicaci√≥n cargada correctamente');
        }

        // ============================================================================
        // LISTENERS EN TIEMPO REAL OPTIMIZADOS
        // ============================================================================
        function configurarListenersTiempoReal() {
            console.log('Configurando listeners en tiempo real...');
            
            // Productos
            db.collection('productos')
                .where('activo', '==', true)
                .orderBy('fechaActualizacion', 'desc')
                .limit(1000)
                .onSnapshot((snapshot) => {
                    productos = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.activo !== false) {
                            productos.push({ id: doc.id, ...data });
                        }
                    });
                    console.log('Productos actualizados (limitado a 1000):', productos.length);
                    configurarAutocompletadoProductos();
                    actualizarEstadisticasSistema();
                }, error => {
                    console.error('Error en listener de productos:', error);
                });
            
            // Proveedores
            db.collection('proveedores')
                .onSnapshot((snapshot) => {
                    proveedores = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.activo !== false) {
                            proveedores.push({ id: doc.id, ...data });
                        }
                    });
                    console.log('Proveedores actualizados:', proveedores.length);
                    actualizarSelectProveedores();
                    actualizarListaProveedores();
                    actualizarEstadisticasSistema();
                }, error => {
                    console.error('Error en listener de proveedores:', error);
                });
            
            // Faltantes
            db.collection('faltantes')
                .orderBy('fechaReporte', 'desc')
                .limit(500)
                .onSnapshot((snapshot) => {
                    faltantes = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        faltantes.push({ id: doc.id, ...data });
                    });
                    
                    console.log('Faltantes actualizados (limitado a 500):', faltantes.length);
                    
                    actualizarDashboard();
                    cargarPedidosPendientes();
                    actualizarContadorFaltantes();
                    actualizarEstadisticasSistema();
                }, error => {
                    console.error('Error en listener de faltantes:', error);
                });
            
            // Pedidos
            db.collection('pedidos')
                .orderBy('fechaPedido', 'desc')
                .limit(200)
                .onSnapshot((snapshot) => {
                    pedidos = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        pedidos.push({ id: doc.id, ...data });
                    });
                    
                    console.log('Pedidos actualizados (limitado a 200):', pedidos.length);
                    
                    actualizarDashboard();
                    cargarPedidosPendientes();
                    cargarPedidosRecientes();
                    actualizarEstadisticasSistema();
                    actualizarRecepcion();
                    
                    if (document.getElementById('historial').classList.contains('active')) {
                        cargarHistorial();
                    }
                }, error => {
                    console.error('Error en listener de pedidos:', error);
                });
        }

        // ============================================================================
        // NAVEGACI√ìN
        // ============================================================================
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            
            const buttons = document.querySelectorAll('.nav-button');
            buttons.forEach(button => {
                if (button.onclick && button.onclick.toString().includes(sectionId)) {
                    button.classList.add('active');
                }
            });
            
            switch(sectionId) {
                case 'dashboard':
                    actualizarDashboard();
                    break;
                case 'pendientes':
                    cargarPedidosPendientes();
                    break;
                case 'recepcion':
                    actualizarRecepcion();
                    break;
                case 'historial':
                    cargarHistorial();
                    break;
                case 'catalogo':
                    showCatalogoTab('productos');
                    break;
                case 'configuracion':
                    cargarConfiguracionUI();
                    break;
            }
        }

        function refreshDashboard() {
            mostrarNotificacion('Actualizando datos...', 'warning', 2000);
            actualizarDashboard();
        }

        // ============================================================================
        // DASHBOARD
        // ============================================================================
        function actualizarDashboard() {
            const sucursalActual = cargarSucursalGuardada();
            
            const faltantesPendientes = faltantes.filter(f => 
                f.estadoFaltante === 'Pendiente' && f.sucursal === sucursalActual
            ).length;
            
            const pedidosEnCamino = pedidos.filter(p => 
                p.estado === 'En camino'
            ).length;
            
            const pedidosRecibidos = pedidos.filter(p => 
                p.estado === 'Recibido'
            ).length;
            
            const faltantesSinStock = faltantes.filter(f => 
                f.estadoStock === 'Sin Stock' && f.estadoFaltante === 'Pendiente' && f.sucursal === sucursalActual
            ).length;
            
            document.getElementById('metricFaltantesPendientes').textContent = faltantesPendientes;
            document.getElementById('metricPedidosCamino').textContent = pedidosEnCamino;
            document.getElementById('metricPedidosRecibidos').textContent = pedidosRecibidos;
            document.getElementById('metricFaltantesSinStock').textContent = faltantesSinStock;
            
            actualizarAlertas();
        }

        function actualizarAlertas() {
            const container = document.getElementById('alertasContainer');
            if (!container) return;
            
            const sucursalActual = cargarSucursalGuardada();
            const alertas = [];
            
            faltantes.forEach(faltante => {
                if (faltante.sucursal === sucursalActual && 
                    faltante.estadoStock === 'Sin Stock' && 
                    faltante.estadoFaltante === 'Pendiente') {
                    alertas.push({
                        tipo: 'urgente',
                        mensaje: `FALTANTE SIN STOCK: ${faltante.producto} (${faltante.cantidad} unidades) - ${faltante.proveedor}`,
                        fecha: faltante.fechaReporte
                    });
                }
            });
            
            pedidos.forEach(pedido => {
                if (pedido.estado === 'En camino') {
                    alertas.push({
                        tipo: 'info',
                        mensaje: `PEDIDO EN CAMINO: ${pedido.proveedor} - ${pedido.productos ? pedido.productos.length : 0} productos`,
                        fecha: pedido.fechaPedido
                    });
                }
            });
            
            if (alertas.length === 0) {
                container.innerHTML = '<div class="alertas-container">‚úÖ No hay alertas pendientes</div>';
                return;
            }
            
            let html = '<div class="alertas-container">';
            html += '<h3>üö® Alertas del Sistema</h3>';
            
            alertas.slice(0, 5).forEach(alerta => {
                html += `
                    <div class="alerta-item ${alerta.tipo === 'urgente' ? 'urgente' : ''}">
                        <strong>${alerta.tipo === 'urgente' ? '‚ö†Ô∏è SIN STOCK:' : 'üì¶ PEDIDO:'}</strong>
                        ${alerta.mensaje}
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ============================================================================
        // CARGA DE DATOS INICIALES OPTIMIZADA
        // ============================================================================
        async function cargarProductosOptimizado() {
            try {
                const snapshot = await db.collection('productos')
                    .where('activo', '==', true)
                    .orderBy('fechaActualizacion', 'desc')
                    .limit(1000)
                    .get();
                
                productos = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.activo !== false) {
                        productos.push({ id: doc.id, ...data });
                    }
                });
                
                console.log('Productos cargados (optimizado):', productos.length);
                configurarAutocompletadoProductos();
            } catch (error) {
                console.error('Error cargando productos:', error);
                mostrarNotificacion('Error cargando productos', 'error');
            }
        }

        async function cargarProveedores() {
            try {
                const snapshot = await db.collection('proveedores').get();
                
                proveedores = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.activo !== false) {
                        proveedores.push({ id: doc.id, ...data });
                    }
                });
                
                console.log('Proveedores cargados:', proveedores.length);
                actualizarSelectProveedores();
            } catch (error) {
                console.error('Error cargando proveedores:', error);
                mostrarNotificacion('Error cargando proveedores', 'error');
            }
        }

        async function cargarFaltantes() {
            try {
                const snapshot = await db.collection('faltantes')
                    .orderBy('fechaReporte', 'desc')
                    .limit(500)
                    .get();
                
                faltantes = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    faltantes.push({ id: doc.id, ...data });
                });
                
                console.log('Faltantes cargados (limitado a 500):', faltantes.length);
            } catch (error) {
                console.error('Error cargando faltantes:', error);
                mostrarNotificacion('Error cargando faltantes', 'error');
            }
        }

        async function cargarPedidos() {
            try {
                const snapshot = await db.collection('pedidos')
                    .orderBy('fechaPedido', 'desc')
                    .limit(200)
                    .get();
                
                pedidos = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    pedidos.push({ id: doc.id, ...data });
                });
                
                console.log('Pedidos cargados (limitado a 200):', pedidos.length);
            } catch (error) {
                console.error('Error cargando pedidos:', error);
                mostrarNotificacion('Error cargando pedidos', 'error');
            }
        }

        // ============================================================================
        // AUTOCOMPLETADO PARA FALTANTES
        // ============================================================================
        function configurarAutocompletadoProductos() {
            const inputProducto = document.getElementById('faltanteProducto');
            const dropdown = document.getElementById('productoDropdown');
            
            if (!inputProducto) return;
            
            const nuevoInput = inputProducto.cloneNode(true);
            inputProducto.parentNode.replaceChild(nuevoInput, inputProducto);
            
            document.getElementById('faltanteProducto').addEventListener('input', function(e) {
                const valor = e.target.value.trim();
                
                console.log('Input value:', valor);
                
                resetearCamposProducto();
                
                if (autocompleteTimeout) {
                    clearTimeout(autocompleteTimeout);
                }
                
                if (!valor || valor.length < 2) {
                    if (dropdown) dropdown.classList.remove('active');
                    ocultarCamposNuevoProducto();
                    return;
                }
                
                if (valor === lastAutocompleteQuery) {
                    return;
                }
                
                lastAutocompleteQuery = valor;
                
                autocompleteTimeout = setTimeout(async () => {
                    await buscarProductosEnFirestoreOptimizado(valor);
                }, 300);
            });
            
            document.addEventListener('click', (e) => {
                if (dropdown && !document.getElementById('faltanteProducto').contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });
        }

        async function buscarProductosEnFirestoreOptimizado(termino) {
            const dropdown = document.getElementById('productoDropdown');
            if (!dropdown) return;
            
            try {
                const snapshot = await db.collection('productos')
                    .where('nombre', '>=', termino)
                    .where('nombre', '<=', termino + '\uf8ff')
                    .where('activo', '==', true)
                    .orderBy('nombre')
                    .limit(AUTCOMPLETE_LIMIT)
                    .get();
                
                const resultados = [];
                snapshot.forEach(doc => {
                    resultados.push({ id: doc.id, ...doc.data() });
                });
                
                mostrarResultadosAutocompletado(resultados, termino);
                
            } catch (error) {
                console.error("Error buscando productos: ", error);
                buscarProductosLocalmente(termino);
            }
        }

        function buscarProductosLocalmente(termino) {
            const dropdown = document.getElementById('productoDropdown');
            if (!dropdown) return;
            
            const searchTerm = termino.toLowerCase();
            const resultados = productos.filter(p => {
                if (!p.nombre || p.activo === false) return false;
                
                const productName = p.nombre.toLowerCase();
                return productName.includes(searchTerm);
            }).slice(0, AUTCOMPLETE_LIMIT);
            
            if (resultados.length > 0) {
                mostrarResultadosAutocompletado(resultados, termino);
            } else {
                mostrarCamposNuevoProducto(termino);
            }
        }

        function resetearCamposProducto() {
            document.getElementById('productoExistenteId').value = '';
            document.getElementById('productoExistenteProveedor').value = '';
            document.getElementById('productoExistenteMedio').value = '';
            document.getElementById('productoExistenteContacto').value = '';
            document.getElementById('productoExistenteLinkWeb').value = '';
            
            document.getElementById('mostrarProveedor').value = '';
            document.getElementById('mostrarMedio').value = '';
            document.getElementById('mostrarContacto').value = '';
            
            document.getElementById('mensajeProducto').classList.add('hidden');
            document.getElementById('camposProductoExistente').classList.add('hidden');
        }

        function mostrarResultadosAutocompletado(resultados, valor) {
            const dropdown = document.getElementById('productoDropdown');
            if (!dropdown) return;
            
            dropdown.innerHTML = '';
            
            if (resultados.length === 0) {
                mostrarCamposNuevoProducto(valor);
                return;
            }
            
            resultados.forEach(producto => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.innerHTML = `
                    <strong>${producto.nombre}</strong><br>
                    <small>${producto.proveedor || 'Sin proveedor'} ‚Ä¢ ${producto.medio || 'WhatsApp'}</small>
                `;
                
                div.addEventListener('click', () => {
                    seleccionarProductoExistente(producto);
                });
                
                dropdown.appendChild(div);
            });
            
            dropdown.classList.add('active');
            ocultarCamposNuevoProducto();
        }

        function seleccionarProductoExistente(producto) {
            document.getElementById('faltanteProducto').value = producto.nombre || '';
            document.getElementById('productoExistenteId').value = producto.id;
            document.getElementById('productoExistenteProveedor').value = producto.proveedor || '';
            document.getElementById('productoExistenteMedio').value = producto.medio || 'WhatsApp';
            document.getElementById('productoExistenteContacto').value = producto.contacto || '';
            document.getElementById('productoExistenteLinkWeb').value = producto.linkWeb || '';
            
            document.getElementById('mostrarProveedor').value = producto.proveedor || '';
            document.getElementById('mostrarMedio').value = producto.medio || 'WhatsApp';
            document.getElementById('mostrarContacto').value = producto.contacto || 'No especificado';
            
            const dropdown = document.getElementById('productoDropdown');
            if (dropdown) dropdown.classList.remove('active');
            
            document.getElementById('camposProductoExistente').classList.remove('hidden');
            ocultarCamposNuevoProducto();
            
            const mensajeDiv = document.getElementById('mensajeProducto');
            mensajeDiv.classList.remove('hidden');
            mensajeDiv.style.background = '#e8f5e9';
            document.getElementById('textoMensaje').innerHTML = `
                ‚úÖ Producto encontrado: <strong>${producto.nombre}</strong><br>
                <small>Proveedor: ${producto.proveedor || 'Sin proveedor'} ‚Ä¢ Medio: ${producto.medio || 'WhatsApp'}</small>
            `;
        }

        function mostrarCamposNuevoProducto(valorProducto) {
            const dropdown = document.getElementById('productoDropdown');
            if (dropdown) dropdown.classList.remove('active');
            
            document.getElementById('camposNuevoProducto').classList.remove('hidden');
            document.getElementById('camposProductoExistente').classList.add('hidden');
            
            document.getElementById('faltanteProducto').value = valorProducto;
            
            document.getElementById('datosProveedorSeleccionado').classList.add('hidden');
            
            const mensajeDiv = document.getElementById('mensajeProducto');
            mensajeDiv.classList.remove('hidden');
            mensajeDiv.style.background = '#e3f2fd';
            document.getElementById('textoMensaje').innerHTML = `
                ‚ú® Producto nuevo: <strong>${valorProducto}</strong><br>
                <small>Selecciona un proveedor existente o crea uno nuevo</small>
            `;
            
            actualizarSelectProveedores();
        }

        function ocultarCamposNuevoProducto() {
            document.getElementById('camposNuevoProducto').classList.add('hidden');
        }

        // ============================================================================
        // FUNCIONES PARA ACTUALIZAR DATOS DE PROVEEDOR SELECCIONADO
        // ============================================================================
        function actualizarDatosProveedorSeleccionado() {
            const select = document.getElementById('nuevoProveedor');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value && selectedOption.dataset.medio) {
                document.getElementById('nuevoMedio').value = selectedOption.dataset.medio;
                document.getElementById('nuevoContacto').value = selectedOption.dataset.contacto || '';
                document.getElementById('nuevoLinkWeb').value = selectedOption.dataset.linkWeb || '';
                
                document.getElementById('mostrarMedioProveedor').value = selectedOption.dataset.medio;
                document.getElementById('mostrarContactoProveedor').value = selectedOption.dataset.medio === 'Web' && selectedOption.dataset.linkWeb ? selectedOption.dataset.linkWeb : selectedOption.dataset.contacto || '';
                document.getElementById('datosProveedorSeleccionado').classList.remove('hidden');
            } else {
                document.getElementById('datosProveedorSeleccionado').classList.add('hidden');
            }
        }

        function actualizarDatosProveedorCatalogo() {
            const select = document.getElementById('productoProveedor');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value && selectedOption.dataset.medio) {
                document.getElementById('productoMedio').value = selectedOption.dataset.medio;
                document.getElementById('productoContacto').value = selectedOption.dataset.contacto || '';
                document.getElementById('productoLinkWeb').value = selectedOption.dataset.linkWeb || '';
                
                document.getElementById('mostrarMedioCatalogo').value = selectedOption.dataset.medio;
                document.getElementById('mostrarContactoCatalogo').value = selectedOption.dataset.medio === 'Web' && selectedOption.dataset.linkWeb ? selectedOption.dataset.linkWeb : selectedOption.dataset.contacto || '';
                document.getElementById('datosProveedorCatalogo').classList.remove('hidden');
            } else {
                document.getElementById('datosProveedorCatalogo').classList.add('hidden');
            }
        }

        // ============================================================================
        // GUARDAR FALTANTE
        // ============================================================================
        async function guardarFaltante(event) {
            event.preventDefault();
            
            if (!usuarioActual) {
                mostrarNotificacion('Debes iniciar sesi√≥n', 'error');
                return;
            }
            
            const productoNombre = document.getElementById('faltanteProducto').value.trim();
            const productoId = document.getElementById('productoExistenteId').value;
            const cantidad = parseInt(document.getElementById('faltanteCantidad').value) || 1;
            const estadoStock = document.getElementById('faltanteStock').value;
            const sucursal = document.getElementById('faltanteSucursal').value;
            
            if (!productoNombre) {
                mostrarNotificacion('El nombre del producto es requerido', 'error');
                return;
            }
            
            if (!sucursal) {
                mostrarNotificacion('La sucursal es requerida', 'error');
                return;
            }
            
            let proveedor, medio, contacto, linkWeb;
            
            if (productoId) {
                proveedor = document.getElementById('productoExistenteProveedor').value;
                medio = document.getElementById('productoExistenteMedio').value;
                contacto = document.getElementById('productoExistenteContacto').value;
                linkWeb = document.getElementById('productoExistenteLinkWeb').value;
            } else {
                proveedor = document.getElementById('nuevoProveedor').value.trim();
                medio = document.getElementById('nuevoMedio').value;
                contacto = document.getElementById('nuevoContacto').value.trim();
                linkWeb = document.getElementById('nuevoLinkWeb').value.trim();
                
                if (!proveedor) {
                    mostrarNotificacion('El proveedor es requerido', 'error');
                    document.getElementById('nuevoProveedor').focus();
                    return;
                }
                
                if (!contacto && medio !== 'Manual') {
                    mostrarNotificacion(`El contacto es requerido para medio ${medio}`, 'error');
                    return;
                }
                
                let proveedorExiste = proveedores.find(p => p.nombre === proveedor);
                
                if (!proveedorExiste) {
                    const proveedorData = {
                        nombre: proveedor,
                        medio: medio,
                        contacto: contacto,
                        linkWeb: linkWeb,
                        activo: true,
                        fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    try {
                        const proveedorRef = await db.collection('proveedores').add(proveedorData);
                        proveedores.push({ id: proveedorRef.id, ...proveedorData });
                        actualizarSelectProveedores();
                    } catch (error) {
                        console.error('Error creando proveedor:', error);
                        mostrarNotificacion('Error al crear proveedor', 'error');
                        return;
                    }
                }
                
                const productoData = {
                    nombre: productoNombre,
                    proveedor: proveedor,
                    medio: medio,
                    contacto: contacto,
                    linkWeb: linkWeb,
                    activo: true,
                    fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
                    fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                try {
                    const docRef = await db.collection('productos').add(productoData);
                    productos.push({ id: docRef.id, ...productoData });
                } catch (error) {
                    console.error('Error creando producto:', error);
                    mostrarNotificacion('Error al crear producto', 'error');
                    return;
                }
            }
            
            const faltanteExistente = faltantes.find(f => 
                f.producto === productoNombre && 
                f.proveedor === proveedor && 
                f.sucursal === sucursal && 
                f.estadoFaltante === 'Pendiente'
            );
            
            if (faltanteExistente) {
                mostrarNotificacion(`Ya existe un faltante pendiente para "${productoNombre}" con el proveedor "${proveedor}" en la sucursal "${sucursal}". No se puede crear un duplicado.`, 'error');
                return;
            }
            
            const productoYaPedido = faltantes.find(f => 
                f.producto === productoNombre && 
                f.proveedor === proveedor && 
                f.sucursal === sucursal && 
                (f.estadoFaltante === 'Pedido')
            );
            
            if (productoYaPedido) {
                let estaEnCamino = false;
                if (productoYaPedido.idPedido) {
                    const pedidoRelacionado = pedidos.find(p => p.id === productoYaPedido.idPedido);
                    if (pedidoRelacionado && pedidoRelacionado.estado === 'En camino') {
                        estaEnCamino = true;
                    }
                }
                
                if (estaEnCamino) {
                    mostrarNotificacion(`El producto "${productoNombre}" ya fue pedido a "${proveedor}" y est√° EN CAMINO para la sucursal "${sucursal}". No se puede volver a reportar hasta que sea recibido o cancelado el pedido.`, 'error');
                    return;
                } else {
                    mostrarNotificacion(`El producto "${productoNombre}" ya fue pedido a "${proveedor}" para la sucursal "${sucursal}". Verifica el estado del pedido en la secci√≥n "Historial" o "Recepci√≥n".`, 'error');
                    return;
                }
            }
            
            const faltanteData = {
                sucursal: sucursal,
                producto: productoNombre,
                proveedor: proveedor,
                medio: medio,
                contacto: contacto,
                linkWeb: linkWeb,
                cantidad: cantidad,
                estadoStock: estadoStock,
                estadoFaltante: 'Pendiente',
                fechaReporte: firebase.firestore.FieldValue.serverTimestamp(),
                usuarioReporte: usuarioActual.email,
                fechaPedido: null,
                idPedido: null
            };
            
            mostrarLoading(true, 'Guardando faltante...');
            
            try {
                await db.collection('faltantes').add(faltanteData);
                mostrarNotificacion('Faltante reportado correctamente');
                limpiarFormularioFaltante();
                
                await registrarLog('Reportar Faltante', faltanteData.producto);
                
            } catch (error) {
                console.error('Error guardando faltante:', error);
                mostrarNotificacion(`Error: ${error.message}`, 'error');
            } finally {
                mostrarLoading(false);
            }
        }

        function limpiarFormularioFaltante() {
            document.getElementById('faltanteForm').reset();
            resetearCamposProducto();
            document.getElementById('mensajeProducto').classList.add('hidden');
            document.getElementById('faltanteCantidad').value = '1';
            document.getElementById('faltanteStock').value = 'Quedan Pocos';
            document.getElementById('datosProveedorSeleccionado').classList.add('hidden');
            
            const sucursalActual = cargarSucursalGuardada();
            document.getElementById('faltanteSucursal').value = sucursalActual;
            
            setTimeout(() => {
                document.getElementById('faltanteProducto').focus();
            }, 100);
        }

        // ============================================================================
        // CONTADOR DE FALTANTES
        // ============================================================================
        function actualizarContadorFaltantes() {
            const sucursalActual = cargarSucursalGuardada();
            const faltantesPendientes = faltantes.filter(f => 
                f.estadoFaltante === 'Pendiente' && f.sucursal === sucursalActual
            ).length;
            
            document.getElementById('contadorFaltantesPendientes').textContent = faltantesPendientes;
        }

        // ============================================================================
        // PEDIDOS PENDIENTES
        // ============================================================================
        function cargarPedidosPendientes() {
            const container = document.getElementById('listaProveedoresPendientes');
            if (!container) return;
            
            const faltantesPendientes = faltantes.filter(f => f.estadoFaltante === 'Pendiente');
            
            if (faltantesPendientes.length === 0) {
                container.innerHTML = `
                    <div class="alertas-container text-center" style="padding: 40px;">
                        <h3>‚úÖ No hay faltantes pendientes</h3>
                        <p>Ve a la secci√≥n de "Faltantes" para reportar productos faltantes.</p>
                        <button class="btn btn-primary mt-2" onclick="showSection('faltantes')">
                            ‚ö†Ô∏è Reportar Faltante
                        </button>
                    </div>
                `;
                return;
            }
            
            const proveedoresMap = {};
            faltantesPendientes.forEach(faltante => {
                if (!proveedoresMap[faltante.proveedor]) {
                    proveedoresMap[faltante.proveedor] = {
                        proveedor: faltante.proveedor,
                        medio: faltante.medio || 'WhatsApp',
                        contacto: faltante.contacto || '',
                        linkWeb: faltante.linkWeb || '',
                        productos: [],
                        sucursales: new Set(),
                        cantidadTotal: 0
                    };
                }
                proveedoresMap[faltante.proveedor].productos.push(faltante);
                proveedoresMap[faltante.proveedor].sucursales.add(faltante.sucursal);
                proveedoresMap[faltante.proveedor].cantidadTotal += faltante.cantidad || 1;
            });
            
            let html = '<table><thead><tr><th>Proveedor</th><th>Productos</th><th>Sucursales</th><th>Acciones</th></tr></thead><tbody>';
            
            Object.values(proveedoresMap).forEach(info => {
                const sucursalesList = Array.from(info.sucursales).join(', ');
                
                html += `
                    <tr>
                        <td>
                            <strong>${info.proveedor}</strong><br>
                            <small>${info.medio} ‚Ä¢ ${info.contacto || 'Sin contacto'}</small>
                        </td>
                        <td>
                            <strong>${info.productos.length} productos</strong><br>
                            <small>Total: ${info.cantidadTotal} unidades</small>
                            <div class="mt-1" style="font-size: 12px;">
                                ${info.productos.slice(0, 2).map(p => `‚Ä¢ ${p.producto} x${p.cantidad || 1}`).join('<br>')}
                                ${info.productos.length > 2 ? '<br>...' : ''}
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-en-camino">${sucursalesList}</span>
                        </td>
                        <td>
                            <div class="btn-group-sm">
                                <button class="btn btn-primary" onclick="verYGenerarPedido('${info.proveedor}')">
                                    üìã Generar Pedido
                                </button>
                                <button class="btn" onclick="verDetalleProveedor('${info.proveedor}')">
                                    üëÅÔ∏è Ver Detalle
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
            cargarPedidosRecientes();
        }

        function cargarPedidosRecientes() {
            const tbody = document.getElementById('pedidosRecientesBody');
            if (!tbody) return;
            
            const pedidosRecientes = pedidos.slice(0, 5);
            
            if (pedidosRecientes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No hay pedidos recientes</td></tr>';
                return;
            }
            
            let html = '';
            pedidosRecientes.forEach(pedido => {
                const totalProductos = pedido.productos ? pedido.productos.length : 0;
                
                html += `
                    <tr>
                        <td>${formatearFecha(pedido.fechaPedido)}</td>
                        <td>${pedido.proveedor}</td>
                        <td>${totalProductos} productos</td>
                        <td>
                            <span class="badge ${pedido.estado === 'En camino' ? 'badge-en-camino' : 
                                                 pedido.estado === 'Recibido' ? 'badge-recibido' : 'badge-cancelado'}">
                                ${pedido.estado}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm" onclick="verDetallePedido('${pedido.id}')">
                                üëÅÔ∏è Ver
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function verDetalleProveedor(proveedorNombre) {
            const faltantesProveedor = faltantes.filter(f => 
                f.estadoFaltante === 'Pendiente' && f.proveedor === proveedorNombre
            );
            
            if (faltantesProveedor.length === 0) {
                mostrarNotificacion('No hay faltantes pendientes para este proveedor', 'error');
                return;
            }
            
            let html = `
                <div class="modal-proveedor">
                    <h3>üìã Detalle: ${proveedorNombre}</h3>
                    <p><strong>Total productos:</strong> ${faltantesProveedor.length}</p>
                    
                    <h4>Productos Pendientes:</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Sucursal</th>
                                    <th>Estado Stock</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            faltantesProveedor.forEach(f => {
                html += `
                    <tr>
                        <td>${f.producto}</td>
                        <td>${f.cantidad || 1}</td>
                        <td>${f.sucursal}</td>
                        <td>
                            <span class="badge ${f.estadoStock === 'Sin Stock' ? 'badge-sin-stock' : 'badge-quedan-pocos'}">
                                ${f.estadoStock}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            const modal = document.getElementById('modalRevision');
            if (!modal) {
                console.error('Modal de revisi√≥n no encontrado');
                mostrarNotificacion('Error al abrir el modal de revisi√≥n', 'error');
                return;
            }
            
            const contenido = document.getElementById('modalContent');
            contenido.innerHTML = html;
            
            const btnConfirmar = document.getElementById('btnConfirmarPedido');
            if (btnConfirmar) btnConfirmar.style.display = 'none';
            
            const modalActions = document.getElementById('modalRevisionActions');
            if (modalActions) {
                modalActions.innerHTML = `
                    <button class="btn" onclick="cerrarModal()">Cerrar</button>
                `;
            }
            
            modal.classList.add('active');
        }

        // ============================================================================
        // FUNCIONES DE PEDIDOS
        // ============================================================================
        function verYGenerarPedido(proveedorNombre) {
            const faltantesProveedor = faltantes.filter(f => 
                f.estadoFaltante === 'Pendiente' && 
                f.proveedor === proveedorNombre
            );
            
            if (faltantesProveedor.length === 0) {
                mostrarNotificacion('No hay faltantes pendientes para este proveedor', 'error');
                return;
            }
            
            const primerFaltante = faltantesProveedor[0];
            const medio = primerFaltante.medio || 'WhatsApp';
            const contacto = primerFaltante.contacto || '';
            const linkWeb = primerFaltante.linkWeb || '';
            
            pedidoEnRevision = {
                proveedor: proveedorNombre,
                medio: medio,
                contacto: contacto,
                linkWeb: linkWeb,
                productos: faltantesProveedor,
                fechaRevisi√≥n: new Date()
            };
            
            mostrarModalRevision(pedidoEnRevision);
        }

        function mostrarModalRevision(pedido) {
            const modal = document.getElementById('modalRevision');
            if (!modal) {
                console.error('Modal de revisi√≥n no encontrado en el DOM');
                mostrarNotificacion('Error: No se pudo abrir el modal de revisi√≥n', 'error');
                return;
            }
            
            const contenido = document.getElementById('modalContent');
            if (!contenido) {
                console.error('Contenido del modal no encontrado');
                return;
            }
            
            const proveedorInfo = proveedores.find(p => p.nombre === pedido.proveedor);
            const medio = proveedorInfo ? proveedorInfo.medio : pedido.medio;
            const contacto = proveedorInfo ? proveedorInfo.contacto : pedido.contacto;
            const linkWeb = proveedorInfo ? proveedorInfo.linkWeb : pedido.linkWeb;
            
            let html = `
                <div class="modal-proveedor">
                    <h4>
                        ${pedido.proveedor}
                        <span class="badge ${medio === 'WhatsApp' ? 'badge-recibido' : 'badge-en-camino'}">
                            ${medio}
                        </span>
                    </h4>
                    
                    <p><strong>Contacto:</strong> ${contacto || 'No especificado'}</p>
                    ${linkWeb ? `<p><strong>Link Web:</strong> <a href="${linkWeb}" target="_blank">${linkWeb}</a></p>` : ''}
                    
                    <h5>üì¶ Productos del Pedido (${pedido.productos.length} productos)</h5>
            `;
            
            const productosPorSucursal = {};
            pedido.productos.forEach(f => {
                if (!productosPorSucursal[f.sucursal]) {
                    productosPorSucursal[f.sucursal] = [];
                }
                productosPorSucursal[f.sucursal].push(f);
            });
            
            Object.keys(productosPorSucursal).forEach(sucursal => {
                html += `<h6>Sucursal: ${sucursal}</h6>`;
                html += `<ul>`;
                productosPorSucursal[sucursal].forEach(f => {
                    html += `<li>${f.producto} x${f.cantidad || 1} (${f.estadoStock || 'Sin Stock'})</li>`;
                });
                html += `</ul>`;
            });
            
            const productosAgrupados = {};
            pedido.productos.forEach(f => {
                if (!productosAgrupados[f.producto]) {
                    productosAgrupados[f.producto] = {
                        producto: f.producto,
                        cantidad: 0,
                        sucursales: new Set()
                    };
                }
                productosAgrupados[f.producto].cantidad += f.cantidad || 1;
                if (f.sucursal) productosAgrupados[f.producto].sucursales.add(f.sucursal);
            });
            
            let listaWeb = '';
            Object.values(productosAgrupados).forEach(p => {
                listaWeb += `${p.producto} x${p.cantidad}\n`;
            });
            
            let mensajeWhatsApp = `Hola buenos d√≠as, te paso el pedido:\n\n`;
            Object.values(productosAgrupados).forEach(p => {
                mensajeWhatsApp += `‚Ä¢ ${p.producto} x${p.cantidad}\n`;
            });
            mensajeWhatsApp += `\nGracias.`;
            
            if (medio === 'Web') {
                html += `
                    <div class="producto-lista" style="background: #fff3e0; border-left: 4px solid #ff9800;">
                        <strong>Lista para copiar y pegar en la web:</strong><br><br>
                        <textarea id="listaWebTextarea" style="width: 100%; height: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;" readonly>${listaWeb}</textarea>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-sm" onclick="copiarListaWeb()">üìã Copiar Lista</button>
                        </div>
                    </div>
                    <div class="alertas-container" style="margin-top: 15px;">
                        <strong>üí° Instrucciones para pedido web:</strong><br>
                        1. Haz clic en "Copiar Lista" para copiar todos los productos<br>
                        2. Haz clic en "Abrir Web del Proveedor" para ir a su p√°gina<br>
                        3. Pega la lista en el formulario de pedido de la web<br>
                        4. Completa el pedido en la web del proveedor<br>
                        5. Regresa aqu√≠ y haz clic en "Confirmar Pedido"<br>
                    </div>
                `;
                
                const btnConfirmar = document.getElementById('btnConfirmarPedido');
                if (btnConfirmar) {
                    btnConfirmar.innerHTML = '‚úÖ Confirmar Pedido Web';
                    btnConfirmar.onclick = function() {
                        confirmarPedido();
                    };
                }
                
                html += `
                    <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                        ${linkWeb ? `<button class="btn btn-primary" onclick="window.open('${linkWeb}', '_blank')">
                            üåê Abrir Web del Proveedor
                        </button>` : ''}
                    </div>
                `;
                
                if (btnConfirmar) {
                    btnConfirmar.style.display = 'inline-flex';
                }
                
            } else if (medio === 'WhatsApp') {
                const numeroWhatsApp = contacto ? contacto.replace(/\D/g, '') : '';
                const urlWhatsApp = numeroWhatsApp ? `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensajeWhatsApp)}` : '#';
                
                html += `
                    <div class="producto-lista" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
                        <strong>Mensaje que se enviar√° por WhatsApp:</strong><br><br>
                        <textarea style="width: 100%; height: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;">${mensajeWhatsApp}</textarea>
                    </div>
                    <p class="text-muted">üì± El mensaje se abrir√° en WhatsApp Web para que lo revises y env√≠es.</p>
                `;
                
                const btnConfirmar = document.getElementById('btnConfirmarPedido');
                if (btnConfirmar) {
                    btnConfirmar.innerHTML = 'üì± Abrir en WhatsApp Web';
                    btnConfirmar.onclick = function() {
                        if (numeroWhatsApp) {
                            window.open(urlWhatsApp, '_blank');
                        }
                        setTimeout(() => {
                            confirmarPedido();
                        }, 1000);
                    };
                }
                
                if (btnConfirmar) {
                    btnConfirmar.style.display = 'inline-flex';
                }
                
            } else {
                html += `
                    <div class="producto-lista">
                        <strong>Lista de productos:</strong><br><br>
                        <textarea style="width: 100%; height: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;">${listaWeb}</textarea>
                    </div>
                    <p class="text-muted">üìû Contacta manualmente al proveedor con esta lista.</p>
                `;
                
                const btnConfirmar = document.getElementById('btnConfirmarPedido');
                if (btnConfirmar) {
                    btnConfirmar.innerHTML = '‚úÖ Confirmar Pedido Manual';
                    btnConfirmar.onclick = function() {
                        confirmarPedido();
                    };
                }
                
                if (btnConfirmar) {
                    btnConfirmar.style.display = 'inline-flex';
                }
            }
            
            html += `</div>`;
            contenido.innerHTML = html;
            modal.classList.add('active');
        }

        function copiarListaWeb() {
            const textarea = document.getElementById('listaWebTextarea');
            if (!textarea) return;
            
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    mostrarNotificacion('Lista copiada al portapapeles', 'success');
                } else {
                    mostrarNotificacion('No se pudo copiar la lista', 'error');
                }
            } catch (err) {
                console.error('Error al copiar:', err);
                mostrarNotificacion('Error al copiar la lista', 'error');
            }
        }

        function cerrarModal() {
            if (procesandoPedido) {
                if (!confirm('El pedido se est√° procesando. ¬øEst√°s seguro de que quieres cancelar?')) {
                    return;
                }
                procesandoPedido = false;
                
                const btnConfirmar = document.getElementById('btnConfirmarPedido');
                if (btnConfirmar) {
                    btnConfirmar.innerHTML = '‚úÖ Confirmar y Generar Pedido';
                    btnConfirmar.disabled = false;
                    btnConfirmar.style.display = 'inline-flex';
                }
            }
            
            const modal = document.getElementById('modalRevision');
            if (modal) {
                modal.classList.remove('active');
            }
            
            pedidoEnRevision = null;
            
            const btnConfirmar = document.getElementById('btnConfirmarPedido');
            if (btnConfirmar) {
                btnConfirmar.innerHTML = '‚úÖ Confirmar y Generar Pedido';
                btnConfirmar.onclick = confirmarPedido;
                btnConfirmar.style.display = 'inline-flex';
                
                const modalActions = document.getElementById('modalRevisionActions');
                if (modalActions) {
                    modalActions.innerHTML = `
                        <button class="btn" onclick="cerrarModal()">Cancelar</button>
                        <button class="btn btn-success" id="btnConfirmarPedido" onclick="confirmarPedido()">‚úÖ Confirmar y Generar Pedido</button>
                    `;
                }
            }
        }

        async function confirmarPedido() {
            if (!pedidoEnRevision) {
                mostrarNotificacion('No hay pedido para confirmar', 'error');
                return;
            }
            
            if (procesandoPedido) {
                mostrarNotificacion('Ya se est√° procesando un pedido', 'warning');
                return;
            }
            
            const btnConfirmar = document.getElementById('btnConfirmarPedido');
            if (!btnConfirmar) {
                mostrarNotificacion('Error: No se encontr√≥ el bot√≥n de confirmaci√≥n', 'error');
                return;
            }
            
            const textoOriginal = btnConfirmar.innerHTML;
            btnConfirmar.innerHTML = '‚è≥ Procesando...';
            btnConfirmar.disabled = true;
            procesandoPedido = true;
            
            mostrarLoading(true, 'Generando pedido...');
            
            try {
                const pedidoData = {
                    proveedor: pedidoEnRevision.proveedor,
                    medio: pedidoEnRevision.medio,
                    contacto: pedidoEnRevision.contacto,
                    linkWeb: pedidoEnRevision.linkWeb,
                    productos: pedidoEnRevision.productos.map(f => ({
                        producto: f.producto,
                        cantidad: f.cantidad || 1,
                        estadoStock: f.estadoStock || 'Sin Stock',
                        sucursal: f.sucursal,
                        idFaltante: f.id
                    })),
                    estado: 'En camino',
                    fechaPedido: firebase.firestore.FieldValue.serverTimestamp(),
                    fechaRecepcion: null,
                    usuarioPedido: usuarioActual.email
                };
                
                const pedidoRef = await db.collection('pedidos').add(pedidoData);
                
                const batch = db.batch();
                pedidoEnRevision.productos.forEach(faltante => {
                    const faltanteRef = db.collection('faltantes').doc(faltante.id);
                    batch.update(faltanteRef, {
                        estadoFaltante: 'Pedido',
                        fechaPedido: firebase.firestore.FieldValue.serverTimestamp(),
                        idPedido: pedidoRef.id
                    });
                });
                
                await batch.commit();
                
                mostrarNotificacion('Pedido generado correctamente');
                
                setTimeout(() => {
                    cerrarModal();
                }, 500);
                
                await registrarLog('Generar Pedido', `${pedidoEnRevision.proveedor} - ${pedidoEnRevision.productos.length} productos`);
                
            } catch (error) {
                console.error('Error generando pedido:', error);
                mostrarNotificacion(`Error: ${error.message}`, 'error');
                procesandoPedido = false;
            } finally {
                mostrarLoading(false);
                if (btnConfirmar) {
                    btnConfirmar.innerHTML = textoOriginal;
                    btnConfirmar.disabled = false;
                }
            }
        }

        function verDetallePedido(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (!pedido) return;
            
            let html = `
                <div class="modal-proveedor">
                    <h4>üìã Detalle del Pedido</h4>
                    <p><strong>Proveedor:</strong> ${pedido.proveedor}</p>
                    <p><strong>Fecha:</strong> ${formatearFecha(pedido.fechaPedido)}</p>
                    <p><strong>Medio:</strong> ${pedido.medio || 'WhatsApp'}</p>
                    <p><strong>Estado:</strong> <span class="badge ${pedido.estado === 'Cancelado' ? 'badge-cancelado' : pedido.estado === 'Recibido' ? 'badge-recibido' : 'badge-en-camino'}">${pedido.estado || 'En camino'}</span></p>
                    
                    <h5>Productos:</h5>
                    <div class="producto-lista" style="max-height: 300px; overflow-y: auto;">
            `;

            if (pedido.productos && pedido.productos.length > 0) {
                const productosPorSucursal = {};
                pedido.productos.forEach(p => {
                    if (!productosPorSucursal[p.sucursal]) {
                        productosPorSucursal[p.sucursal] = [];
                    }
                    productosPorSucursal[p.sucursal].push(p);
                });
                
                Object.keys(productosPorSucursal).forEach(sucursal => {
                    html += `<h6>Sucursal: ${sucursal || 'No especificada'}</h6>`;
                    html += `<ul>`;
                    productosPorSucursal[sucursal].forEach(p => {
                        html += `<li>${p.producto} x${p.cantidad || 1} (${p.estadoStock || 'Sin Stock'})</li>`;
                    });
                    html += `</ul>`;
                });
            } else {
                html += 'No hay productos registrados';
            }
            
            html += `
                    </div>
                </div>
            `;
            
            const modal = document.getElementById('modalRevision');
            if (!modal) {
                mostrarNotificacion('Error: No se pudo abrir el modal de detalle', 'error');
                return;
            }
            
            const contenido = document.getElementById('modalContent');
            contenido.innerHTML = html;
            
            const btnConfirmar = document.getElementById('btnConfirmarPedido');
            if (btnConfirmar) btnConfirmar.style.display = 'none';
            
            const modalActions = document.getElementById('modalRevisionActions');
            if (modalActions) {
                modalActions.innerHTML = `
                    <button class="btn" onclick="cerrarModal()">Cerrar</button>
                `;
            }
            
            modal.classList.add('active');
        }

        // ============================================================================
        // RECEPCI√ìN DE PEDIDOS
        // ============================================================================
        function actualizarRecepcion() {
            filtrarRecepcion();
        }

        function filtrarRecepcion() {
            const sucursalActual = cargarSucursalGuardada();
            const filtroProveedor = document.getElementById('filterRecepcionProveedor').value.toLowerCase();
            const filtroEstado = document.getElementById('filterRecepcionEstado').value;
            const filtroSucursal = document.getElementById('filterRecepcionSucursal').value;
            
            let pedidosFiltrados = pedidos;
            
            if (filtroProveedor) {
                pedidosFiltrados = pedidosFiltrados.filter(p => 
                    p.proveedor && p.proveedor.toLowerCase().includes(filtroProveedor)
                );
            }
            
            if (filtroEstado) {
                pedidosFiltrados = pedidosFiltrados.filter(p => p.estado === filtroEstado);
            }
            
            if (filtroSucursal === 'solo-mis-productos') {
                pedidosFiltrados = pedidosFiltrados.filter(pedido => {
                    return pedido.productos && pedido.productos.some(p => p.sucursal === sucursalActual);
                });
            } else if (filtroSucursal) {
                pedidosFiltrados = pedidosFiltrados.filter(pedido => {
                    return pedido.productos && pedido.productos.some(p => p.sucursal === filtroSucursal);
                });
            }
            
            const tbody = document.getElementById('recepcionTableBody');
            if (!tbody) return;
            
            if (pedidosFiltrados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center" style="padding: 40px;">
                            üì≠ No hay pedidos que coincidan con los filtros
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            pedidosFiltrados.forEach(pedido => {
                const totalProductos = pedido.productos ? pedido.productos.length : 0;
                const totalCantidad = pedido.productos ? 
                    pedido.productos.reduce((sum, p) => sum + (p.cantidad || 1), 0) : 0;
                
                const productosPorSucursal = {};
                if (pedido.productos) {
                    pedido.productos.forEach(p => {
                        if (!productosPorSucursal[p.sucursal]) {
                            productosPorSucursal[p.sucursal] = { cantidad: 0, productos: 0 };
                        }
                        productosPorSucursal[p.sucursal].cantidad += p.cantidad || 1;
                        productosPorSucursal[p.sucursal].productos++;
                    });
                }
                
                const sucursalesInfo = Object.keys(productosPorSucursal).map(sucursal => {
                    const info = productosPorSucursal[sucursal];
                    return `${sucursal || 'No especificada'}: ${info.productos} prod. (${info.cantidad} unid.)`;
                }).join('<br>');
                
                const listaProductos = pedido.productos ? 
                    pedido.productos.slice(0, 3).map(p => `${p.producto} x${p.cantidad || 1}`).join(', ') +
                    (totalProductos > 3 ? `... (+${totalProductos - 3})` : '') : '';
                
                html += `
                    <tr>
                        <td>${formatearFecha(pedido.fechaPedido)}</td>
                        <td>${pedido.proveedor || ''}</td>
                        <td title="${listaProductos}">${totalProductos} productos</td>
                        <td>
                            <div style="font-size: 12px;">
                                ${sucursalesInfo}
                            </div>
                        </td>
                        <td>${totalCantidad}</td>
                        <td>
                            <span class="badge ${pedido.estado === 'Cancelado' ? 'badge-cancelado' : pedido.estado === 'Recibido' ? 'badge-recibido' : 'badge-en-camino'}">
                                ${pedido.estado || 'En camino'}
                            </span>
                        </td>
                        <td>
                            ${pedido.estado === 'En camino' ? `
                                <button class="btn btn-sm btn-primary" onclick="verDetalleRecepcion('${pedido.id}')">
                                    üìã Ver Detalle
                                </button>
                            ` : formatearFecha(pedido.fechaRecepcion)}
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function verDetalleRecepcion(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (!pedido) {
                mostrarNotificacion('Pedido no encontrado', 'error');
                return;
            }

            const sucursalActual = cargarSucursalGuardada();
            pedidoEnRecepcion = pedido;
            
            let html = `
                <div class="modal-proveedor">
                    <h4>üì¶ Recepci√≥n de Pedido</h4>
                    <p><strong>Proveedor:</strong> ${pedido.proveedor}</p>
                    <p><strong>Fecha Pedido:</strong> ${formatearFecha(pedido.fechaPedido)}</p>
                    <p><strong>Tu Sucursal:</strong> ${sucursalActual}</p>
                    
                    <h5>üìã Productos del Pedido (${pedido.productos ? pedido.productos.length : 0})</h5>
                    <p><small>Marca solo los productos que llegaron a <strong>${sucursalActual}</strong></small></p>
                    
                    <div class="producto-lista" style="max-height: 400px; overflow-y: auto; margin: 15px 0;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; text-align: left; width: 40px;">Recibido</th>
                                    <th style="padding: 10px; text-align: left;">Producto</th>
                                    <th style="padding: 10px; text-align: left;">Cantidad</th>
                                    <th style="padding: 10px; text-align: left;">Sucursal</th>
                                    <th style="padding: 10px; text-align: left;">Estado Stock</th>
                                </tr>
                            </thead>
                            <tbody id="listaProductosRecepcion">
            `;

            if (pedido.productos && pedido.productos.length > 0) {
                pedido.productos.forEach((producto, index) => {
                    const esParaSucursalActual = producto.sucursal === sucursalActual;
                    const checked = esParaSucursalActual ? 'checked' : '';
                    const disabled = !esParaSucursalActual ? 'disabled' : '';
                    const title = esParaSucursalActual ? 
                        'Marcar como recibido' : 
                        `Este producto es para ${producto.sucursal || 'otra sucursal'}`;
                    
                    html += `
                        <tr>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">
                                <input type="checkbox" 
                                       id="prod-${index}" 
                                       data-idfaltante="${producto.idFaltante || ''}"
                                       ${checked} ${disabled}
                                       class="producto-checkbox"
                                       title="${title}">
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">
                                ${producto.producto || ''}
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">
                                ${producto.cantidad || 1}
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">
                                ${producto.sucursal || 'No especificada'}
                                ${esParaSucursalActual ? ' ‚úÖ' : ''}
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">
                                <span class="badge ${producto.estadoStock === 'Sin Stock' ? 'badge-sin-stock' : 'badge-quedan-pocos'}">
                                    ${producto.estadoStock || 'Sin Stock'}
                                </span>
                            </td>
                        </tr>
                    `;
                });
            } else {
                html += `
                    <tr>
                        <td colspan="5" style="padding: 20px; text-align: center;">
                            No hay productos en este pedido
                        </td>
                    </tr>
                `;
            }

            html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="alertas-container mt-3">
                        <strong>üí° Instrucciones:</strong><br>
                        1. <strong>Marca solo los productos</strong> que llegaron a tu sucursal (${sucursalActual})<br>
                        2. Los productos para otras sucursales aparecer√°n deshabilitados<br>
                        3. Al confirmar, solo se cerrar√°n los faltantes de los productos marcados<br>
                        4. Cada sucursal debe gestionar la recepci√≥n de sus propios productos
                    </div>
                </div>
            `;

            const modal = document.getElementById('modalRecepcion');
            const contenido = document.getElementById('modalRecepcionContent');
            contenido.innerHTML = html;
            
            modal.classList.add('active');
        }

        function cerrarModalRecepcion() {
            document.getElementById('modalRecepcion').classList.remove('active');
            pedidoEnRecepcion = null;
        }

        async function confirmarRecepcionParcial() {
            if (!pedidoEnRecepcion) {
                mostrarNotificacion('No hay pedido para recepci√≥n', 'error');
                return;
            }
            
            const sucursalActual = cargarSucursalGuardada();
            
            const productosRecibidos = [];
            const checkboxes = document.querySelectorAll('#listaProductosRecepcion input[type="checkbox"]:checked');
            
            checkboxes.forEach(checkbox => {
                const idFaltante = checkbox.getAttribute('data-idfaltante');
                if (idFaltante) {
                    productosRecibidos.push(idFaltante);
                }
            });
            
            if (productosRecibidos.length === 0) {
                mostrarNotificacion('Debes marcar al menos un producto como recibido', 'error');
                return;
            }
            
            if (!confirm(`¬øConfirmar recepci√≥n de ${productosRecibidos.length} producto(s) para ${sucursalActual}?`)) return;
            
            mostrarLoading(true, 'Marcando productos como recibidos...');
            
            try {
                const batch = db.batch();
                productosRecibidos.forEach(idFaltante => {
                    const faltanteRef = db.collection('faltantes').doc(idFaltante);
                    batch.update(faltanteRef, {
                        estadoFaltante: 'Cerrado',
                        fechaRecepcion: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                await batch.commit();
                
                const todosRecibidos = await verificarTodosProductosRecibidos(pedidoEnRecepcion.id);
                
                if (todosRecibidos) {
                    await db.collection('pedidos').doc(pedidoEnRecepcion.id).update({
                        estado: 'Recibido',
                        fechaRecepcion: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    mostrarNotificacion('Pedido completo marcado como recibido');
                } else {
                    mostrarNotificacion(`${productosRecibidos.length} producto(s) recibidos para ${sucursalActual}`);
                }
                
                await cargarFaltantes();
                await cargarPedidos();
                
                await registrarLog('Recibir Productos', `${productosRecibidos.length} productos recibidos para ${sucursalActual}`);
                
                cerrarModalRecepcion();
                
            } catch (error) {
                console.error('Error recibiendo productos:', error);
                mostrarNotificacion(`Error: ${error.message}`, 'error');
            } finally {
                mostrarLoading(false);
            }
        }

        async function verificarTodosProductosRecibidos(pedidoId) {
            try {
                const snapshot = await db.collection('faltantes')
                    .where('idPedido', '==', pedidoId)
                    .get();
                
                let todosRecibidos = true;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.estadoFaltante !== 'Cerrado') {
                        todosRecibidos = false;
                    }
                });
                
                return todosRecibidos;
            } catch (error) {
                console.error('Error verificando recepci√≥n completa:', error);
                return false;
            }
        }

        // ============================================================================
        // HISTORIAL
        // ============================================================================
        function cargarHistorial() {
            console.log('Cargando historial con', pedidos.length, 'pedidos');
            
            const desde = document.getElementById('filterFechaDesde').value;
            const hasta = document.getElementById('filterFechaHasta').value;
            const estado = document.getElementById('filterEstadoHistorial').value;
            const proveedor = document.getElementById('filterProveedorHistorial').value.toLowerCase();
            
            let pedidosFiltrados = pedidos;
            
            if (desde) {
                const fechaDesde = new Date(desde);
                fechaDesde.setHours(0, 0, 0, 0);
                
                pedidosFiltrados = pedidosFiltrados.filter(p => {
                    if (!p.fechaPedido) return true;
                    
                    let fechaPedido;
                    if (p.fechaPedido && p.fechaPedido.toDate) {
                        fechaPedido = p.fechaPedido.toDate();
                    } else if (p.fechaPedido) {
                        fechaPedido = new Date(p.fechaPedido);
                    } else {
                        fechaPedido = new Date();
                    }
                    
                    return fechaPedido >= fechaDesde;
                });
            }
            
            if (hasta) {
                const fechaHasta = new Date(hasta);
                fechaHasta.setHours(23, 59, 59, 999);
                
                pedidosFiltrados = pedidosFiltrados.filter(p => {
                    if (!p.fechaPedido) return true;
                    
                    let fechaPedido;
                    if (p.fechaPedido && p.fechaPedido.toDate) {
                        fechaPedido = p.fechaPedido.toDate();
                    } else if (p.fechaPedido) {
                        fechaPedido = new Date(p.fechaPedido);
                    } else {
                        fechaPedido = new Date();
                    }
                    
                    return fechaPedido <= fechaHasta;
                });
            }
            
            if (estado) {
                pedidosFiltrados = pedidosFiltrados.filter(p => p.estado === estado);
            }
            
            if (proveedor) {
                pedidosFiltrados = pedidosFiltrados.filter(p => 
                    p.proveedor && p.proveedor.toLowerCase().includes(proveedor)
                );
            }
            
            const tbody = document.getElementById('historialBody');
            if (!tbody) {
                console.error('No se encontr√≥ el tbody del historial');
                return;
            }
            
            if (pedidosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay pedidos que coincidan con los filtros</td></tr>';
                actualizarEstadisticasHistorial();
                return;
            }
            
            pedidosFiltrados.sort((a, b) => {
                let fechaA = a.fechaPedido;
                let fechaB = b.fechaPedido;
                
                if (fechaA && fechaA.toDate) fechaA = fechaA.toDate();
                if (fechaB && fechaB.toDate) fechaB = fechaB.toDate();
                
                if (!fechaA || !fechaB) return 0;
                
                return new Date(fechaB) - new Date(fechaA);
            });
            
            let html = '';
            pedidosFiltrados.forEach(pedido => {
                const totalProductos = pedido.productos ? pedido.productos.length : 0;
                
                let sucursales = 'No especificadas';
                if (pedido.productos && pedido.productos.length > 0) {
                    const sucursalesSet = new Set();
                    pedido.productos.forEach(p => {
                        if (p.sucursal) sucursalesSet.add(p.sucursal);
                    });
                    sucursales = Array.from(sucursalesSet).join(', ') || 'No especificadas';
                }
                
                let badgeClass = 'badge-en-camino';
                if (pedido.estado === 'Recibido') {
                    badgeClass = 'badge-recibido';
                } else if (pedido.estado === 'Cancelado') {
                    badgeClass = 'badge-cancelado';
                }
                
                html += `
                    <tr>
                        <td>${formatearFecha(pedido.fechaPedido)}</td>
                        <td>${pedido.proveedor || 'Sin proveedor'}</td>
                        <td>${totalProductos} productos</td>
                        <td>${sucursales}</td>
                        <td>
                            <span class="badge ${badgeClass}">
                                ${pedido.estado || 'Sin estado'}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group-sm">
                                <button class="btn btn-sm" onclick="verDetallePedido('${pedido.id}')">
                                    üëÅÔ∏è Ver
                                </button>
                                ${pedido.estado === 'En camino' ? `
                                <button class="btn btn-sm btn-warning" onclick="cancelarPedido('${pedido.id}')">
                                    ‚ùå Cancelar
                                </button>
                                ` : ''}
                                <button class="btn btn-sm btn-danger" onclick="eliminarPedido('${pedido.id}')">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            actualizarEstadisticasHistorial();
        }

        function filtrarHistorial() {
            cargarHistorial();
        }

        function actualizarEstadisticasHistorial() {
            const desde = document.getElementById('filterFechaDesde').value;
            const hasta = document.getElementById('filterFechaHasta').value;
            const estado = document.getElementById('filterEstadoHistorial').value;
            const proveedor = document.getElementById('filterProveedorHistorial').value.toLowerCase();
            
            let pedidosFiltrados = pedidos;
            
            if (desde) {
                const fechaDesde = new Date(desde);
                fechaDesde.setHours(0, 0, 0, 0);
                pedidosFiltrados = pedidosFiltrados.filter(p => {
                    if (!p.fechaPedido) return true;
                    
                    let fechaPedido;
                    if (p.fechaPedido && p.fechaPedido.toDate) {
                        fechaPedido = p.fechaPedido.toDate();
                    } else if (p.fechaPedido) {
                        fechaPedido = new Date(p.fechaPedido);
                    } else {
                        fechaPedido = new Date();
                    }
                    
                    return fechaPedido >= fechaDesde;
                });
            }
            
            if (hasta) {
                const fechaHasta = new Date(hasta);
                fechaHasta.setHours(23, 59, 59, 999);
                pedidosFiltrados = pedidosFiltrados.filter(p => {
                    if (!p.fechaPedido) return true;
                    
                    let fechaPedido;
                    if (p.fechaPedido && p.fechaPedido.toDate) {
                        fechaPedido = p.fechaPedido.toDate();
                    } else if (p.fechaPedido) {
                        fechaPedido = new Date(p.fechaPedido);
                    } else {
                        fechaPedido = new Date();
                    }
                    
                    return fechaPedido <= fechaHasta;
                });
            }
            
            if (estado) {
                pedidosFiltrados = pedidosFiltrados.filter(p => p.estado === estado);
            }
            
            if (proveedor) {
                pedidosFiltrados = pedidosFiltrados.filter(p => 
                    p.proveedor && p.proveedor.toLowerCase().includes(proveedor)
                );
            }
            
            document.getElementById('totalPedidos').textContent = pedidosFiltrados.length;
            document.getElementById('pedidosRecibidos').textContent = pedidosFiltrados.filter(p => p.estado === 'Recibido').length;
            document.getElementById('pedidosEnCamino').textContent = pedidosFiltrados.filter(p => p.estado === 'En camino').length;
            document.getElementById('pedidosCancelados').textContent = pedidosFiltrados.filter(p => p.estado === 'Cancelado').length;
        }

        // ============================================================================
        // PAGINACI√ìN DEL CAT√ÅLOGO DE PRODUCTOS
        // ============================================================================
        async function cargarCatalogoProductos(reset = true) {
            if (reset) {
                currentPage = 1;
                productosCatalogo = [];
                lastVisibleProduct = null;
                firstVisibleProduct = null;
                
                const tbody = document.getElementById('productosTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center" style="padding: 40px;">
                                <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto;"></div>
                                <p class="mt-2">Cargando productos...</p>
                            </td>
                        </tr>
                    `;
                }
            }
            
            mostrarLoading(true, `Cargando p√°gina ${currentPage}...`);
            
            try {
                let query = db.collection('productos')
                    .where('activo', '==', true)
                    .orderBy('fechaActualizacion', 'desc');
                
                if (currentPage === 1) {
                    query = query.limit(pageSize);
                } else if (lastVisibleProduct) {
                    query = query.startAfter(lastVisibleProduct).limit(pageSize);
                } else {
                    query = query.limit(pageSize);
                }
                
                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    mostrarProductosCatalogo([]);
                    if (currentPage === 1) {
                        mostrarNotificacion('No hay productos para mostrar', 'info');
                    }
                    mostrarLoading(false);
                    return;
                }
                
                const nuevosProductos = [];
                snapshot.forEach(doc => {
                    nuevosProductos.push({ id: doc.id, ...doc.data() });
                });
                
                lastVisibleProduct = snapshot.docs[snapshot.docs.length - 1];
                
                if (reset) {
                    productosCatalogo = nuevosProductos;
                } else {
                    productosCatalogo = [...productosCatalogo, ...nuevosProductos];
                }
                
                mostrarProductosCatalogo(productosCatalogo);
                
                actualizarControlesPaginacionSimplificada(snapshot.docs.length === pageSize);
                
            } catch (error) {
                console.error('Error cargando cat√°logo:', error);
                mostrarNotificacion('Error cargando productos', 'error');
                await cargarTodosProductos();
            } finally {
                mostrarLoading(false);
            }
        }

        function mostrarProductosCatalogo(productosLista) {
            const tbody = document.getElementById('productosTableBody');
            if (!tbody) return;
            
            if (productosLista.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center" style="padding: 40px;">
                            üì≠ No hay productos registrados
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            productosLista.forEach(producto => {
                let contactoDisplay = producto.contacto || '-';
                if (producto.medio === 'Web' && producto.linkWeb) {
                    contactoDisplay = `<a href="${producto.linkWeb}" target="_blank">${producto.linkWeb}</a>`;
                }
                
                html += `
                    <tr>
                        <td>${producto.nombre || ''}</td>
                        <td>${producto.proveedor || ''}</td>
                        <td>${producto.medio || 'WhatsApp'}</td>
                        <td>${contactoDisplay}</td>
                        <td>
                            <div class="btn-group-sm">
                                <button class="btn btn-sm btn-primary" onclick="editarProducto('${producto.id}')">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="desactivarProducto('${producto.id}')">
                                    üóëÔ∏è Desactivar
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function actualizarControlesPaginacionSimplificada(tieneMasElementos) {
            const paginationControls = document.getElementById('paginationControls');
            const mobileLoadMore = document.getElementById('mobileLoadMore');
            
            if (productosCatalogo.length >= pageSize || tieneMasElementos) {
                paginationControls.style.display = 'flex';
                mobileLoadMore.style.display = window.innerWidth < 768 ? 'block' : 'none';
                
                document.getElementById('btnPrevPage').disabled = currentPage <= 1;
                document.getElementById('btnNextPage').disabled = !tieneMasElementos;
                
                document.getElementById('currentPage').textContent = currentPage;
                document.getElementById('totalPages').textContent = tieneMasElementos ? currentPage + 1 : currentPage;
            } else {
                paginationControls.style.display = 'none';
                mobileLoadMore.style.display = 'none';
            }
        }

        async function cargarTodosProductos() {
            try {
                const snapshot = await db.collection('productos')
                    .where('activo', '==', true)
                    .orderBy('fechaActualizacion', 'desc')
                    .limit(200)
                    .get();
                
                productosCatalogo = [];
                snapshot.forEach(doc => {
                    productosCatalogo.push({ id: doc.id, ...doc.data() });
                });
                
                mostrarProductosCatalogo(productosCatalogo);
                
                document.getElementById('paginationControls').style.display = 'none';
                document.getElementById('mobileLoadMore').style.display = 'none';
                
            } catch (error) {
                console.error('Error en fallback:', error);
            }
        }

        // ============================================================================
        // FUNCIONES DEL CRUD DE PRODUCTOS Y PROVEEDORES
        // ============================================================================
        function mostrarFormularioProducto(producto = null) {
            const container = document.getElementById('productoFormContainer');
            const title = document.getElementById('productoFormTitle');
            
            if (producto) {
                title.textContent = 'Editar Producto';
                document.getElementById('productoId').value = producto.id;
                document.getElementById('productoNombre').value = producto.nombre || '';
                document.getElementById('productoProveedor').value = producto.proveedor || '';
                
                setTimeout(() => {
                    const select = document.getElementById('productoProveedor');
                    if (select) {
                        select.value = producto.proveedor || '';
                        actualizarDatosProveedorCatalogo();
                    }
                }, 100);
            } else {
                title.textContent = 'Nuevo Producto';
                document.getElementById('productoForm').reset();
                document.getElementById('productoId').value = '';
                document.getElementById('datosProveedorCatalogo').classList.add('hidden');
            }
            
            container.classList.remove('hidden');
            container.scrollIntoView({ behavior: 'smooth' });
        }

        function ocultarFormularioProducto() {
            document.getElementById('productoFormContainer').classList.add('hidden');
        }

        async function guardarProducto(event) {
            event.preventDefault();
            
            const productoId = document.getElementById('productoId').value;
            const productoData = {
                nombre: document.getElementById('productoNombre').value.trim(),
                proveedor: document.getElementById('productoProveedor').value.trim(),
                medio: document.getElementById('productoMedio').value,
                contacto: document.getElementById('productoContacto').value.trim(),
                linkWeb: document.getElementById('productoLinkWeb').value.trim(),
                activo: true,
                fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (!productoData.nombre) {
                mostrarNotificacion('El nombre del producto es requerido', 'error');
                return;
            }
            
            if (!productoData.proveedor) {
                mostrarNotificacion('El proveedor es requerido', 'error');
                return;
            }
            
            if (!productoData.contacto && productoData.medio !== 'Manual') {
                mostrarNotificacion(`El contacto es requerido para medio ${productoData.medio}`, 'error');
                return;
            }
            
            mostrarLoading(true, productoId ? 'Actualizando producto...' : 'Guardando producto...');
            
            try {
                if (productoId) {
                    await db.collection('productos').doc(productoId).update(productoData);
                    mostrarNotificacion('Producto actualizado correctamente');
                } else {
                    productoData.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('productos').add(productoData);
                    mostrarNotificacion('Producto creado correctamente');
                }
                
                await cargarCatalogoProductos(true);
                
                ocultarFormularioProducto();
                
            } catch (error) {
                console.error('Error guardando producto:', error);
                mostrarNotificacion(`Error: ${error.message}`, 'error');
            } finally {
                mostrarLoading(false);
            }
        }

        function editarProducto(productoId) {
            const producto = productosCatalogo.find(p => p.id === productoId) || 
                            productos.find(p => p.id === productoId);
            if (producto) {
                mostrarFormularioProducto(producto);
            }
        }

        async function desactivarProducto(productoId) {
            if (!confirm('¬øDesactivar este producto?')) return;
            
            mostrarLoading(true, 'Desactivando producto...');
            
            try {
                await db.collection('productos').doc(productoId).update({
                    activo: false,
                    fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                mostrarNotificacion('Producto desactivado correctamente');
                
                await cargarCatalogoProductos(true);
                
            } catch (error) {
                console.error('Error desactivando producto:', error);
                mostrarNotificacion(`Error: ${error.message}`, 'error');
            } finally {
                mostrarLoading(false);
            }
        }

        function actualizarListaProveedores() {
            const tbody = document.getElementById('proveedoresTableBody');
            if (!tbody) return;
            
            if (proveedores.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center" style="padding: 40px;">
                            üì≠ No hay proveedores registrados
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            proveedores.forEach(proveedor => {
                let contactoDisplay = proveedor.contacto || '-';
                if (proveedor.medio === 'Web' && proveedor.linkWeb) {
                    contactoDisplay = `<a href="${proveedor.linkWeb}" target="_blank">${proveedor.linkWeb}</a>`;
                }
                
                html += `
                    <tr>
                        <td>${proveedor.nombre || ''}</td>
                        <td>${proveedor.medio || 'WhatsApp'}</td>
                        <td>${contactoDisplay}</td>
                        <td>${proveedor.linkWeb ? `<a href="${proveedor.linkWeb}" target="_blank">Ver</a>` : '-'}</td>
                        <td>
                            <span class="badge ${proveedor.activo !== false ? 'badge-recibido' : 'badge-pendiente'}">
                                ${proveedor.activo !== false ? 'Activo' : 'Inactivo'}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group-sm">
                                <button class="btn btn-sm btn-primary" onclick="editarProveedorModal('${proveedor.id}')">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="desactivarProveedor('${proveedor.id}')">
                                    üóëÔ∏è ${proveedor.activo !== false ? 'Desactivar' : 'Activar'}
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // ============================================================================
        // FUNCIONES DE PROVEEDORES
        // ============================================================================
        function abrirModalNuevoProveedor() {
            nuevoProveedorDesde = 'productos';
            document.getElementById('formNuevoProveedor').reset();
            document.getElementById('nuevoProveedorMedio').value = 'WhatsApp';
            actualizarCampoContactoProveedor();
            document.getElementById('modalNuevoProveedor').classList.add('active');
        }

        function abrirModalNuevoProveedorDesdeFaltante() {
            nuevoProveedorDesde = 'faltantes';
            document.getElementById('formNuevoProveedor').reset();
            document.getElementById('nuevoProveedorMedio').value = 'WhatsApp';
            actualizarCampoContactoProveedor();
            document.getElementById('modalNuevoProveedor').classList.add('active');
        }

        function cerrarModalNuevoProveedor() {
            document.getElementById('modalNuevoProveedor').classList.remove('active');
            nuevoProveedorDesde = null;
        }

        function actualizarCampoContactoProveedor() {
            const medio = document.getElementById('nuevoProveedorMedio').value;
            const label = document.getElementById('labelNuevoProveedorContacto');
            const input = document.getElementById('nuevoProveedorContacto');
            
            if (medio === 'Web') {
                label.textContent = 'Link Web *';
                input.placeholder = 'https://ejemplo.com/pedidos';
                input.type = 'url';
                input.required = true;
            } else if (medio === 'WhatsApp') {
                label.textContent = 'N√∫mero de WhatsApp *';
                input.placeholder = 'Ej: 11 1234-5678';
                input.type = 'text';
                input.required = true;
            } else {
                label.textContent = 'Contacto *';
                input.placeholder = 'Ej: Juan - 11 1234-5678';
                input.type = 'text';
                input.required = true;
            }
        }

        async function guardarNuevoProveedor(event) {
            event.preventDefault();
            
            const proveedorData = {
                nombre: document.getElementById('nuevoProveedorNombre').value.trim(),
                medio: document.getElementById('nuevoProveedorMedio').value,
                contacto: document.getElementById('nuevoProveedorContacto').value.trim(),
                linkWeb: document.getElementById('nuevoProveedorLinkWeb').value.trim(),
                activo: true,
                fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (!proveedorData.nombre) {
                mostrarNotificacion('El nombre del proveedor es requerido', 'error');
                return;
            }
            
            if (!proveedorData.contacto && proveedorData.medio !== 'Manual') {
                mostrarNotificacion(`El contacto es requerido para medio ${proveedorData.medio}`, 'error');
                return;
            }
            
            mostrarLoading(true, 'Guardando proveedor...');
            
            try {
                const docRef = await db.collection('proveedores').add(proveedorData);
                
                mostrarNotificacion('Proveedor creado correctamente');
                cerrarModalNuevoProveedor();
                
                await cargarProveedores();
                actualizarSelectProveedores();
                
                await registrarLog('Crear Proveedor', proveedorData.nombre);
                
            } catch (error) {
                console.error('Error guardando proveedor:', error);
                mostrarNotificacion(`Error: ${error.message}`, 'error');
            } finally {
                mostrarLoading(false);
            }
        }

        async function editarProveedorModal(proveedorId) {
            const proveedor = proveedores.find(p => p.id === proveedorId);
            if (!proveedor) {
                mostrarNotificacion('Proveedor no encontrado', 'error');
                return;
            }
            
            document.getElementById('editarProveedorId').value = proveedor.id;
            document.getElementById('editarProveedorNombre').value = proveedor.nombre || '';
            document.getElementById('editarProveedorMedio').value = proveedor.medio || 'WhatsApp';
            document.getElementById('editarProveedorContacto').value = proveedor.contacto || '';
            document.getElementById('editarProveedorLinkWeb').value = proveedor.linkWeb || '';
            
            actualizarCampoContactoEditar();
            
            document.getElementById('modalEditarProveedor').classList.add('active');
        }

        function cerrarModalEditarProveedor() {
            document.getElementById('modalEditarProveedor').classList.remove('active');
        }

        function actualizarCampoContactoEditar() {
            const medio = document.getElementById('editarProveedorMedio').value;
            const label = document.getElementById('labelEditarProveedorContacto');
            const input = document.getElementById('editarProveedorContacto');
            
            if (medio === 'Web') {
                label.textContent = 'Link Web *';
                input.placeholder = 'https://ejemplo.com/pedidos';
                input.type = 'url';
                input.required = true;
            } else if (medio === 'WhatsApp') {
                label.textContent = 'N√∫mero de WhatsApp *';
                input.placeholder = 'Ej: 11 1234-5678';
                input.type = 'text';
                input.required = true;
            } else {
                label.textContent = 'Contacto *';
                input.placeholder = 'Ej: Juan - 11 1234-5678';
                input.type = 'text';
                input.required = true;
            }
        }

        async function actualizarProveedor(event) {
            event.preventDefault();
            
            const proveedorId = document.getElementById('editarProveedorId').value;
            const proveedorData = {
                nombre: document.getElementById('editarProveedorNombre').value.trim(),
                medio: document.getElementById('editarProveedorMedio').value,
                contacto: document.getElementById('editarProveedorContacto').value.trim(),
                linkWeb: document.getElementById('editarProveedorLinkWeb').value.trim(),
                fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (!proveedorData.nombre) {
                mostrarNotificacion('El nombre del proveedor es requerido', 'error');
                return;
            }
            
            if (!proveedorData.contacto && proveedorData.medio !== 'Manual') {
                mostrarNotificacion(`El contacto es requerido para medio ${proveedorData.medio}`, 'error');
                return;
            }
            
            mostrarLoading(true, 'Actualizando proveedor...');
            
            try {
                await db.collection('proveedores').doc(proveedorId).update(proveedorData);
                
                mostrarNotificacion('Proveedor actualizado correctamente');
                cerrarModalEditarProveedor();
                
                await cargarProveedores();
                actualizarSelectProveedores();
                
                await registrarLog('Actualizar Proveedor', proveedorData.nombre);
                
            } catch (error) {
                console.error('Error actualizando proveedor:', error);
                mostrarNotificacion(`Error: ${error.message}`, 'error');
            } finally {
                mostrarLoading(false);
            }
        }

        async function desactivarProveedor(proveedorId) {
            const proveedor = proveedores.find(p => p.id === proveedorId);
            if (!proveedor) {
                mostrarNotificacion('Proveedor no encontrado', 'error');
                return;
            }
            
            const activoActual = proveedor.activo !== false;
            const accion = activoActual ? 'desactivar' : 'activar';
            if (!confirm(`¬ø${accion.charAt(0).toUpperCase() + accion.slice(1)} este proveedor?`)) return;
            
            mostrarLoading(true, `${accion.charAt(0).toUpperCase() + accion.slice(1)} proveedor...`);
            
            try {
                await db.collection('proveedores').doc(proveedorId).update({
                    activo: !activoActual,
                    fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                mostrarNotificacion(`Proveedor ${accion}do correctamente`);
                
                await cargarProveedores();
                actualizarSelectProveedores();
                
                await registrarLog(`${accion.charAt(0).toUpperCase() + accion.slice(1)} Proveedor`, proveedor.nombre);
                
            } catch (error) {
                console.error(`Error ${accion}do proveedor:`, error);
                mostrarNotificacion(`Error: ${error.message}`, 'error');
            } finally {
                mostrarLoading(false);
            }
        }

        // ============================================================================
        // SELECT DE PROVEEDORES
        // ============================================================================
        function actualizarSelectProveedores() {
            function crearOptions(selectId, proveedoresList) {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const valorActual = select.value;
                
                select.innerHTML = '<option value="">Seleccionar proveedor...</option>';
                
                if (proveedoresList.length === 0) return;
                
                proveedoresList.forEach(proveedor => {
                    const option = document.createElement('option');
                    option.value = proveedor.nombre || '';
                    option.textContent = proveedor.nombre || 'Sin nombre';
                    option.dataset.medio = proveedor.medio || 'WhatsApp';
                    option.dataset.contacto = proveedor.contacto || '';
                    option.dataset.linkWeb = proveedor.linkWeb || '';
                    select.appendChild(option);
                });
                
                if (valorActual && Array.from(select.options).some(opt => opt.value === valorActual)) {
                    select.value = valorActual;
                    const event = new Event('change');
                    select.dispatchEvent(event);
                }
            }
            
            if (proveedores.length > 0) {
                crearOptions('productoProveedor', proveedores);
                crearOptions('nuevoProveedor', proveedores);
            }
        }

        // ============================================================================
        // FUNCIONES DE PEDIDOS (CANCELAR Y ELIMINAR)
        // ============================================================================
        async function cancelarPedido(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (!pedido) {
                mostrarNotificacion('Pedido no encontrado', 'error');
                return;
            }
            
            if (pedido.estado === 'Recibido') {
                if (!confirm('Este pedido ya fue recibido. ¬øSeguro que quieres cancelarlo?\n\nLos productos volver√°n a estado "Pendiente".')) {
                    return;
                }
            } else {
                if (!confirm('¬øCancelar este pedido?\n\nLos productos volver√°n a estado "Pendiente".')) {
                    return;
                }
            }
            
            mostrarLoading(true, 'Cancelando pedido...');
            
            try {
                await db.collection('pedidos').doc(pedidoId).update({
                    estado: 'Cancelado',
                    fechaCancelacion: firebase.firestore.FieldValue.serverTimestamp(),
                    motivoCancelacion: 'Cancelado por usuario'
                });
                
                if (pedido.productos && pedido.productos.length > 0) {
                    const batch = db.batch();
                    
                    pedido.productos.forEach(producto => {
                        if (producto.idFaltante) {
                            const faltanteRef = db.collection('faltantes').doc(producto.idFaltante);
                            batch.update(faltanteRef, {
                                estadoFaltante: 'Pendiente',
                                fechaPedido: null,
                                idPedido: null
                            });
                        }
                    });
                    
                    await batch.commit();
                }
                
                mostrarNotificacion('Pedido cancelado correctamente');
                
                await Promise.all([
                    cargarFaltantes(),
                    cargarPedidos()
                ]);
                
                await registrarLog('Cancelar Pedido', `${pedido.proveedor} - ID: ${pedidoId}`);
                
            } catch (error) {
                console.error('Error cancelando pedido:', error);
                mostrarNotificacion(`Error: ${error.message}`, 'error');
            } finally {
                mostrarLoading(false);
            }
        }

        async function eliminarPedido(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (!pedido) {
                mostrarNotificacion('Pedido no encontrado', 'error');
                return;
            }
            
            if (!confirm(`¬øELIMINAR DEFINITIVAMENTE este pedido?\n\nProveedor: ${pedido.proveedor}\nFecha: ${formatearFecha(pedido.fechaPedido)}\n\nEsta acci√≥n NO se puede deshacer.`)) {
                return;
            }
            
            mostrarLoading(true, 'Eliminando pedido...');
            
            try {
                await db.collection('pedidos').doc(pedidoId).delete();
                
                if (pedido.estado !== 'Cancelado' && pedido.productos && pedido.productos.length > 0) {
                    const batch = db.batch();
                    
                    pedido.productos.forEach(producto => {
                        if (producto.idFaltante) {
                            const faltanteRef = db.collection('faltantes').doc(producto.idFaltante);
                            batch.update(faltanteRef, {
                                estadoFaltante: 'Pendiente',
                                fechaPedido: null,
                                idPedido: null
                            });
                        }
                    });
                    
                    await batch.commit();
                }
                
                mostrarNotificacion('Pedido eliminado correctamente');
                
                await Promise.all([
                    cargarFaltantes(),
                    cargarPedidos()
                ]);
                
                await registrarLog('Eliminar Pedido', `${pedido.proveedor} - ID: ${pedidoId}`);
                
            } catch (error) {
                console.error('Error eliminando pedido:', error);
                mostrarNotificacion(`Error: ${error.message}`, 'error');
            } finally {
                mostrarLoading(false);
            }
        }

        // ============================================================================
        // CONFIGURACI√ìN DEL SISTEMA
        // ============================================================================
        function cargarConfiguracionUI() {
            const selectSucursal = document.getElementById('selectSucursalConfig');
            if (selectSucursal) {
                selectSucursal.innerHTML = '';
                sucursales.forEach(sucursal => {
                    const option = document.createElement('option');
                    option.value = sucursal;
                    option.textContent = sucursal;
                    if (sucursal === cargarSucursalGuardada()) {
                        option.selected = true;
                    }
                    selectSucursal.appendChild(option);
                });
            }
            
            const config = cargarConfigLimpieza();
            document.getElementById('diasLimpiezaConfig').value = config.diasRetencion;
            document.getElementById('autoLimpiezaConfig').checked = config.autoLimpieza;
            
            // Deshabilitar an√°lisis autom√°tico
            document.getElementById('autoAnalisis').checked = false;
            document.getElementById('autoAnalisis').disabled = true;
            
            actualizarEstadisticasSistema();
            actualizarEstadisticasConfigLimpieza();
        }

        function cambiarSucursalDesdeConfig() {
            const select = document.getElementById('selectSucursalConfig');
            if (select && select.value) {
                guardarSucursal(select.value);
                mostrarNotificacion(`Sucursal cambiada a: ${select.value}`, 'success');
                actualizarDashboard();
                cargarPedidosPendientes();
                actualizarRecepcion();
            }
        }

        function guardarConfiguracion() {
            configLimpieza.diasRetencion = parseInt(document.getElementById('diasLimpiezaConfig').value) || 30;
            configLimpieza.autoLimpieza = document.getElementById('autoLimpiezaConfig').checked;
            
            localStorage.setItem('configLimpiezaPedidos', JSON.stringify(configLimpieza));
            mostrarNotificacion('Configuraci√≥n guardada correctamente', 'success');
        }

        function actualizarEstadisticasSistema() {
            document.getElementById('totalProductosSistema').textContent = productos.length;
            document.getElementById('totalProveedoresSistema').textContent = proveedores.length;
            document.getElementById('totalFaltantesSistema').textContent = faltantes.length;
            document.getElementById('totalPedidosSistema').textContent = pedidos.length;
        }

        function actualizarEstadisticasConfigLimpieza() {
            const ahora = new Date();
            const limite = new Date(ahora);
            limite.setDate(limite.getDate() - configLimpieza.diasRetencion);
            
            const pedidosParaLimpiar = pedidos.filter(pedido => {
                if (pedido.estado !== 'Recibido') return false;
                
                let fechaRecepcion = pedido.fechaRecepcion;
                if (fechaRecepcion && fechaRecepcion.toDate) {
                    fechaRecepcion = fechaRecepcion.toDate();
                }
                
                if (!fechaRecepcion) return false;
                
                return fechaRecepcion < limite;
            }).length;
            
            const totalPedidos = pedidos.length;
            const pedidosRecibidos = pedidos.filter(p => p.estado === 'Recibido').length;
            
            document.getElementById('estadisticasConfigLimpieza').innerHTML = `
                ‚Ä¢ Total pedidos: <strong>${totalPedidos}</strong><br>
                ‚Ä¢ Pedidos recibidos: <strong>${pedidosRecibidos}</strong><br>
                ‚Ä¢ Para limpiar (m√°s de ${configLimpieza.diasRetencion} d√≠as): <strong class="text-warning">${pedidosParaLimpiar}</strong>
            `;
        }

        // ============================================================================
        // FUNCIONES DE LIMPIEZA
        // ============================================================================
        function abrirModalConfigLimpieza() {
            cargarConfigLimpieza();
            
            document.getElementById('diasRetencion').value = configLimpieza.diasRetencion;
            document.getElementById('autoLimpieza').checked = configLimpieza.autoLimpieza;
            
            actualizarEstadisticasConfigLimpieza();
            document.getElementById('modalConfigLimpieza').classList.add('active');
        }

        function cerrarModalConfigLimpieza() {
            document.getElementById('modalConfigLimpieza').classList.remove('active');
        }

        function guardarConfigLimpieza(event) {
            event.preventDefault();
            
            configLimpieza = {
                diasRetencion: parseInt(document.getElementById('diasRetencion').value) || 30,
                autoLimpieza: document.getElementById('autoLimpieza').checked
            };
            
            localStorage.setItem('configLimpiezaPedidos', JSON.stringify(configLimpieza));
            mostrarNotificacion('Configuraci√≥n de limpieza guardada', 'success');
            cerrarModalConfigLimpieza();
            
            actualizarEstadisticasConfigLimpieza();
            
            return false;
        }

        async function ejecutarLimpiezaManual() {
            if (!confirm(`¬øEliminar pedidos recibidos hace m√°s de ${configLimpieza.diasRetencion} d√≠as?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            await limpiarPedidosAntiguos();
        }

        async function limpiarPedidosAntiguos() {
            const ahora = new Date();
            const limite = new Date(ahora);
            limite.setDate(limite.getDate() - configLimpieza.diasRetencion);
            
            const pedidosParaLimpiar = pedidos.filter(pedido => {
                if (pedido.estado !== 'Recibido') return false;
                
                let fechaRecepcion = pedido.fechaRecepcion;
                if (fechaRecepcion && fechaRecepcion.toDate) {
                    fechaRecepcion = fechaRecepcion.toDate();
                }
                
                if (!fechaRecepcion) return false;
                
                return fechaRecepcion < limite;
            });
            
            if (pedidosParaLimpiar.length === 0) {
                mostrarNotificacion('No hay pedidos antiguos para limpiar', 'success');
                return;
            }
            
            mostrarLoading(true, `Limpiando ${pedidosParaLimpiar.length} pedidos antiguos...`);
            
            try {
                const batch = db.batch();
                let eliminados = 0;
                
                for (const pedido of pedidosParaLimpiar) {
                    const pedidoRef = db.collection('pedidos').doc(pedido.id);
                    batch.delete(pedidoRef);
                    eliminados++;
                }
                
                await batch.commit();
                
                mostrarNotificacion(`${eliminados} pedidos antiguos eliminados`, 'success');
                await registrarLog('Limpieza Autom√°tica', `${eliminados} pedidos eliminados`);
                
                await cargarPedidos();
                
            } catch (error) {
                console.error('Error en limpieza de pedidos:', error);
                mostrarNotificacion(`Error: ${error.message}`, 'error');
            } finally {
                mostrarLoading(false);
            }
        }

        // ============================================================================
        // FUNCIONES UTILITARIAS
        // ============================================================================
        function exportarDatos() {
            const datos = {
                productos: productosCatalogo,
                proveedores: proveedores,
                faltantes: faltantes,
                pedidos: pedidos,
                fechaExportacion: new Date().toISOString(),
                sucursal: cargarSucursalGuardada()
            };
            
            const datosJSON = JSON.stringify(datos, null, 2);
            const blob = new Blob([datosJSON], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ferreteria_datos_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacion('Datos exportados correctamente');
        }

        function limpiarCache() {
            if (confirm('¬øLimpiar cache local?\n\nEsto no afectar√° los datos en Firebase.')) {
                localStorage.clear();
                mostrarNotificacion('Cache limpiado correctamente', 'success');
                location.reload();
            }
        }

        // ============================================================================
        // FUNCIONES PARA BORRAR BASE DE DATOS
        // ============================================================================
        function confirmarBorrarDB() {
            const password = document.getElementById('passwordBorrarDB').value;
            if (password !== '201200fc') {
                mostrarNotificacion('Contrase√±a incorrecta', 'error');
                return;
            }

            if (!confirm('¬øEST√ÅS ABSOLUTAMENTE SEGURO DE BORRAR TODA LA BASE DE DATOS?\n\nEsta acci√≥n eliminar√°:\n- Todos los productos\n- Todos los proveedores\n- Todos los faltantes\n- Todos los pedidos\n- Todos los logs\n\nEsta acci√≥n NO SE PUEDE DESHACER.')) {
                return;
            }

            mostrarLoading(true, 'Borrando base de datos...');
            borrarBaseDeDatos();
        }

        async function borrarBaseDeDatos() {
            try {
                const colecciones = ['productos', 'proveedores', 'faltantes', 'pedidos', 'logs', 'usuarios'];

                for (const coleccion of colecciones) {
                    const querySnapshot = await db.collection(coleccion).get();
                    const batch = db.batch();
                    querySnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    console.log(`Colecci√≥n ${coleccion} borrada`);
                }

                localStorage.clear();

                mostrarNotificacion('Base de datos borrada correctamente', 'success');
                
                setTimeout(() => {
                    location.reload();
                }, 2000);

            } catch (error) {
                console.error('Error borrando base de datos:', error);
                mostrarNotificacion(`Error: ${error.message}`, 'error');
            } finally {
                mostrarLoading(false);
            }
        }

        // ============================================================================
        // LOGS
        // ============================================================================
        async function registrarLog(accion, detalle) {
            try {
                await db.collection('logs').add({
                    fecha: firebase.firestore.FieldValue.serverTimestamp(),
                    usuario: usuarioActual.email,
                    accion: accion,
                    detalle: detalle,
                    sucursal: cargarSucursalGuardada()
                });
            } catch (error) {
                console.error('Error registrando log:', error);
            }
        }

        // ============================================================================
        // FUNCIONES DE PAGINACI√ìN
        // ============================================================================
        function cargarPaginaSiguiente() {
            currentPage++;
            cargarCatalogoProductos(false);
        }

        function cargarPaginaAnterior() {
            if (currentPage > 1) {
                currentPage--;
                cargarCatalogoProductos(true);
            }
        }

        function cargarMasProductos() {
            cargarPaginaSiguiente();
        }

        // ============================================================================
        // CARGAR CONFIGURACI√ìN AL INICIAR
        // ============================================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, inicializando...');
            
            cargarConfigLimpieza();
        });

        // ============================================================================
        // EXPORTAR FUNCIONES AL √ÅMBITO GLOBAL
        // ============================================================================
        window.showSection = showSection;
        window.refreshDashboard = refreshDashboard;
        window.mostrarFormularioProducto = mostrarFormularioProducto;
        window.ocultarFormularioProducto = ocultarFormularioProducto;
        window.guardarProducto = guardarProducto;
        window.editarProducto = editarProducto;
        window.desactivarProducto = desactivarProducto;
        window.guardarFaltante = guardarFaltante;
        window.limpiarFormularioFaltante = limpiarFormularioFaltante;
        window.verYGenerarPedido = verYGenerarPedido;
        window.verDetalleRecepcion = verDetalleRecepcion;
        window.confirmarRecepcionParcial = confirmarRecepcionParcial;
        window.filtrarRecepcion = filtrarRecepcion;
        window.actualizarRecepcion = actualizarRecepcion;
        window.logout = logout;
        window.showLoginTab = showLoginTab;
        window.cambiarSucursal = cambiarSucursal;
        window.cerrarModal = cerrarModal;
        window.confirmarPedido = confirmarPedido;
        window.verDetallePedido = verDetallePedido;
        window.abrirModalNuevoProveedor = abrirModalNuevoProveedor;
        window.abrirModalNuevoProveedorDesdeFaltante = abrirModalNuevoProveedorDesdeFaltante;
        window.cerrarModalNuevoProveedor = cerrarModalNuevoProveedor;
        window.cerrarModalEditarProveedor = cerrarModalEditarProveedor;
        window.cerrarModalRecepcion = cerrarModalRecepcion;
        window.editarProveedorModal = editarProveedorModal;
        window.actualizarProveedor = actualizarProveedor;
        window.desactivarProveedor = desactivarProveedor;
        window.showCatalogoTab = showCatalogoTab;
        window.cancelarPedido = cancelarPedido;
        window.eliminarPedido = eliminarPedido;
        window.abrirModalConfigLimpieza = abrirModalConfigLimpieza;
        window.cerrarModalConfigLimpieza = cerrarModalConfigLimpieza;
        window.ejecutarLimpiezaManual = ejecutarLimpiezaManual;
        window.cambiarSucursalDesdeConfig = cambiarSucursalDesdeConfig;
        window.guardarConfiguracion = guardarConfiguracion;
        window.exportarDatos = exportarDatos;
        window.limpiarCache = limpiarCache;
        window.filtrarHistorial = filtrarHistorial;
        window.confirmarBorrarDB = confirmarBorrarDB;
        window.borrarBaseDeDatos = borrarBaseDeDatos;
        window.copiarListaWeb = copiarListaWeb;
        window.actualizarDatosProveedorSeleccionado = actualizarDatosProveedorSeleccionado;
        window.actualizarDatosProveedorCatalogo = actualizarDatosProveedorCatalogo;
        // FUNCIONES DE AN√ÅLISIS LOCAL - CONFIRMACI√ìN REQUERIDA
        window.confirmarAnalisis = confirmarAnalisis;
        window.actualizarAnalisisLocal = actualizarAnalisisLocal;
        window.mostrarReglasNegocio = mostrarReglasNegocio;
        // FUNCIONES DE MONITOREO DE CONSUMO
        window.actualizarMonitoreoConsumo = actualizarMonitoreoConsumo;
        window.resetearContadoresDiarios = resetearContadoresDiarios;
        window.exportarReporteConsumo = exportarReporteConsumo;
        window.mostrarConsumoDetallado = mostrarConsumoDetallado;
        // FUNCIONES DE PAGINACI√ìN
        window.cargarPaginaSiguiente = cargarPaginaSiguiente;
        window.cargarPaginaAnterior = cargarPaginaAnterior;
        window.cargarMasProductos = cargarMasProductos;
    </script>
</body>
</html>
